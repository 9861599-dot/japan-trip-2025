<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- å¼·åŠ›é˜²æ­¢å¿«å–çš„ Meta æ¨™ç±¤ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Chiikawa Trip v2.6</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fff1f2">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1908/1908344.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Kosugi Maru', -apple-system, sans-serif;
            background-color: #fff1f2;
            background-image: radial-gradient(#fecdd3 1px, transparent 1px);
            background-size: 20px 20px;
            color: #475569;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(251, 113, 133, 0.15);
            border: 2px solid #fff;
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
        }
        .app-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: linear-gradient(to right, #f9a8d4, #f472b6);
        }

        .tag-base { @apply px-2.5 py-1 rounded-full text-xs font-bold mr-1.5 mb-1 inline-block border-2 shadow-sm; }
        .tag-food { @apply bg-orange-100 text-orange-600 border-orange-200; }
        .tag-buy { @apply bg-rose-100 text-rose-600 border-rose-200; }
        .tag-transport { @apply bg-blue-100 text-blue-600 border-blue-200; }
        .tag-highlight { @apply bg-yellow-100 text-yellow-700 border-yellow-200; }
        .tag-code { @apply bg-purple-100 text-purple-600 border-purple-200 font-mono tracking-wider; }
        .tag-cost { @apply bg-emerald-100 text-emerald-600 border-emerald-200; }

        .btn-cute {
            @apply active:scale-95 transition-transform rounded-2xl font-bold shadow-md border-b-4 active:border-b-0 active:translate-y-1;
        }

        /* Loading å‹•ç•« */
        .chiikawa-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- é€™è£¡æ”¹ç”¨ module æ¨¡å¼ä¾†æ”¯æ´ Firebase import -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, collection } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // =========================================
        // ğŸš‘ PWA æ®ºæ‰‹ç¨‹å¼ç¢¼ v3 (å®‰å…¨ç‰ˆ)
        // =========================================
        if ('serviceWorker' in navigator) {
            try {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister().catch(err => console.warn(err));
                    }
                }).catch(err => console.warn(err));
            } catch (e) { console.warn(e); }

            if ('caches' in window) {
                try {
                    caches.keys().then(function(names) {
                        for (let name of names) caches.delete(name);
                    }).catch(err => console.warn(err));
                } catch (e) { console.warn(e); }
            }
        }

        const { useState, useEffect, useRef } = React;

        // =========================================
        // 1. è¨­å®š Firebase Config
        // =========================================
        const getFirebaseConfig = () => {
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    return JSON.parse(__firebase_config);
                }
            } catch (e) {
                console.log("Not in preview mode or config invalid");
            }
            
            return {
                apiKey: "AIzaSyCpOfvR92qEkDHDZio8jZ4VR-tru2MScSQ",
                authDomain: "japan-trip-2025-5f3a3.firebaseapp.com",
                projectId: "japan-trip-2025-5f3a3",
                storageBucket: "japan-trip-2025-5f3a3.firebasestorage.app",
                messagingSenderId: "828851638958",
                appId: "1:828851638958:web:59bad47902fe08671b933f"
            };
        };

        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TRIP_DOC_PATH = ['artifacts', appId, 'public', 'data', 'trips', 'shared_japan_2025'];
        const LOCAL_STORAGE_KEY = 'trip_data_v2_6'; 

        // =========================================
        // æ–°ç‰ˆè³‡æ–™çµæ§‹ (åŒ—é™¸æ±äº¬ 8 å¤©)
        // =========================================
        const defaultItinerary = [
            {
                id: 'day1', date: '5/10 (æ—¥)', title: 'æ¡ƒåœ’ â†’ å°æ¾ â†’ é‡‘æ¾¤',
                location: 'é‡‘æ¾¤',
                weather: { icon: 'fa-plane', text: 'å‡ºç™¼æ—¥', alert: false },
                events: [
                    { id: 'e1-1', type: 'transport', time: '12:10', title: 'IT 252 èµ·é£›', desc: 'æ¡ƒåœ’ â†’ å°æ¾æ©Ÿå ´ (16:05 æŠµé”)ã€‚', location: 'æ¡ƒåœ’åœ‹éš›æ©Ÿå ´' },
                    { id: 'e1-2', type: 'transport', time: '17:00', title: 'æ©Ÿå ´å·´å£« â†’ é‡‘æ¾¤', desc: 'å‡ºé—œå¾Œå·¦è½‰æ­è»Šã€‚ç´„40åˆ†ã€‚', location: 'å°æ¾æ©Ÿå ´', cost: 1150 },
                    { id: 'e1-3', type: 'food', time: '18:30', title: 'é‡‘æ¾¤æ™šé¤', desc: 'é‡‘æ¾¤è»Šç«™å‘¨é‚Šç¾é£Ÿã€‚', location: 'é‡‘æ¾¤è»Šç«™' },
                    { id: 'e1-4', type: 'accommodation', time: '20:00', title: 'ä½å®¿: é‡‘æ¾¤å¤§é…’åº—', desc: 'æˆ– MYSTAYS é‡‘æ¾¤ç²¾å“é…’åº—ã€‚', location: 'Kanazawa Hotel', bookingCode: '5949989585-PIN:3738', cost: 60554, note: '5/8å‰å¯å–æ¶ˆ' },
                ]
            },
            {
                id: 'day2', date: '5/11 (ä¸€)', title: 'é‡‘æ¾¤å¤éƒ½ä¸€æ—¥éŠ',
                location: 'é‡‘æ¾¤',
                weather: { icon: 'fa-sun', text: 'é©åˆæ‹ç…§', alert: false },
                events: [
                    { id: 'e2-1', type: 'transport', time: '09:00', title: 'Loop Bus ä¸€æ—¥åˆ¸', desc: 'JR é‡‘æ¾¤ç«™è³¼è²·ã€‚', location: 'é‡‘æ¾¤è»Šç«™', cost: 600 },
                    { id: 'e2-2', type: 'sight', time: '09:30', title: 'å…¼å…­åœ’ & é‡‘æ¾¤åŸ', desc: 'å»ºè­°ç”±æ¡‚å‚å£é€²å…¥ï¼Œæ—©ä¸Šå…‰ç·šæœ€ç¾ã€‚', location: 'å…¼å…­åœ’' },
                    { id: 'e2-3', type: 'food', time: '12:00', title: 'åˆé¤: è¿‘æ±Ÿç”ºå¸‚å ´', desc: 'å¿…åƒæµ·é®®ä¸¼ (å±±ã•ã‚“å£½å¸ã€ã‚‚ã‚Šã‚‚ã‚Šå¯¿å¸)ã€‚', location: 'è¿‘æ±Ÿç”ºå¸‚å ´' },
                    { id: 'e2-4', type: 'sight', time: '14:00', title: 'æ±èŒ¶å±‹è¡—', desc: 'ç®”ä¸€é‡‘ç®”å†°æ·‡æ·‹ã€ä¹…é€£æ³¢å’Œè“å­ã€‚', location: 'æ±èŒ¶å±‹è¡—' },
                    { id: 'e2-5', type: 'sight', time: '16:00', title: 'é•·ç”ºæ­¦å®¶å±‹æ•·', desc: 'å¤è‰²å¤é¦™çš„æ­¦å£«è¡—é“ã€‚', location: 'é•·ç”ºæ­¦å®¶å±‹æ•·è·¡' },
                    { id: 'e2-6', type: 'food', time: '18:00', title: 'æ™šé¤: é‡‘æ¾¤å’–å“©', desc: 'æ¿ƒéƒé»‘å’–å“©ã€‚', location: 'Go Go Curry' },
                    { id: 'e2-7', type: 'accommodation', time: '20:00', title: 'ä½å®¿: é‡‘æ¾¤çºŒä½', desc: 'åŒç¬¬ä¸€æ™šã€‚', location: 'Kanazawa Hotel' },
                ]
            },
            {
                id: 'day3', date: '5/12 (äºŒ)', title: 'åˆæŒæ‘ â†’ é£›é©’é«˜å±±',
                location: 'é«˜å±±',
                weather: { icon: 'fa-car', text: 'è‡ªé§•æ—¥', alert: false },
                events: [
                    { id: 'e3-1', type: 'transport', time: '09:00', title: 'ç§Ÿè»Šå‡ºç™¼', desc: 'è‡ªé§•å‰å¾€ç™½å·é„‰ã€‚', location: 'é‡‘æ¾¤è»Šç«™ç§Ÿè»Š' },
                    { id: 'e3-2', type: 'sight', time: '10:30', title: 'ç™½å·é„‰åˆæŒæ‘', desc: 'ä¸–ç•Œéºç”¢ç«¥è©±æ‘è½ã€‚', location: 'ç™½å·é„‰' },
                    { id: 'e3-3', type: 'food', time: '12:30', title: 'åˆé¤: åˆæŒæ‘', desc: 'äº”å¹³é¤…ã€è•éº¥éºµã€‚', location: 'ç™½å·é„‰' },
                    { id: 'e3-4', type: 'transport', time: '14:30', title: 'å‰å¾€é«˜å±±', desc: 'å‰å¾€é£›é©’é«˜å±±å¤è¡—ã€‚', location: 'é«˜å±±ä¸‰ç”ºç­‹' },
                    { id: 'e3-5', type: 'sight', time: '15:30', title: 'é«˜å±±å¤è¡—', desc: 'é£›é©’ç‰›å£½å¸ã€å‘³å¢ä¸²ã€‚', location: 'é«˜å±±è€è¡—' },
                    { id: 'e3-6', type: 'food', time: '18:00', title: 'æ™šé¤: é£›é©’ç‰›ä¸€é ­å®¶', desc: 'é ‚ç´šé£›é©’ç‰›ç‡’è‚‰ã€‚', location: 'é£›é©’ç‰›ä¸€é ­å®¶' },
                    { id: 'e3-7', type: 'accommodation', time: '20:00', title: 'ä½å®¿: Residence é«˜å±±', desc: 'æˆ– fav Hide é«˜å±±ã€‚è¨‚å–®: 6171736740-PIN:1772', location: 'Residence Hotel Takayama Station', bookingCode: '6171736740', cost: 55869 },
                ]
            },
            {
                id: 'day4', date: '5/13 (ä¸‰)', title: 'é«˜å±±æœå¸‚ â†’ å¯Œå±±',
                location: 'å¯Œå±±',
                weather: { icon: 'fa-cloud-sun', text: 'ç§»å‹•æ—¥', alert: false },
                events: [
                    { id: 'e4-1', type: 'sight', time: '08:00', title: 'å®®å·æœå¸‚', desc: 'æ¸…æ™¨æ•£æ­¥ï¼Œé€›å¸‚é›†ã€‚', location: 'å®®å·æœå¸‚' },
                    { id: 'e4-2', type: 'transport', time: '14:00', title: 'å‰å¾€å¯Œå±±', desc: 'JRé«˜å±±æœ¬ç·š (ç´„1.5å°æ™‚)ã€‚', location: 'å¯Œå±±è»Šç«™', cost: 2860 },
                    { id: 'e4-3', type: 'accommodation', time: '16:00', title: 'ä½å®¿: æ±æ©«INN å¯Œå±±ç«™', desc: 'æ–°å¹¹ç·šå£2è™Ÿåº—ã€‚è¨‚å–®: 5361206-7', location: 'Toyoko Inn Toyama-eki Shinkansen-guchi No.2', bookingCode: '5361206-7', cost: 40870 },
                    { id: 'e4-4', type: 'food', time: '18:00', title: 'å¯Œå±±æ™šé¤', desc: 'ç™½è¦æ–™ç†ã€å¯Œå±±é»‘æ‹‰éºµã€‚', location: 'å¯Œå±±è»Šç«™' },
                ]
            },
            {
                id: 'day5', date: '5/14 (å››)', title: 'ç©¿è¶Šç«‹å±±é»‘éƒ¨',
                location: 'é•·é‡',
                weather: { icon: 'fa-snowflake', text: 'é«˜å±±æ°£å€™', alert: true },
                events: [
                    { id: 'e5-1', type: 'transport', time: '07:00', title: 'â˜… å¯„è¡Œæ', desc: 'å°‡å¤§è¡Œæå¯„å¾€é•·é‡/æ±äº¬ã€‚', location: 'å¯Œå±±è»Šç«™' },
                    { id: 'e5-2', type: 'transport', time: '08:00', title: 'é›»éµ å¯Œå±±â†’ç«‹å±±ç«™', desc: 'ç´„1å°æ™‚ã€‚', location: 'ç«‹å±±ç«™', cost: 1230 },
                    { id: 'e5-3', type: 'sight', time: '10:00', title: 'ç«‹å±±é»‘éƒ¨ç©¿è¶Š', desc: 'ç¾å¥³å¹³ã€å®¤å ‚(é›ªå£)ã€å¤§è§€å³°ã€é»‘éƒ¨æ°´åº«ã€‚', location: 'å®¤å ‚' },
                    { id: 'e5-4', type: 'transport', time: '15:00', title: 'æ‰‡æ¾¤ â†’ é•·é‡ç«™', desc: 'ALPICOå·´å£«ï¼Œç´„1å°æ™‚40åˆ†ã€‚', location: 'æ‰‡æ¾¤ç«™', cost: 2000 },
                    { id: 'e5-5', type: 'accommodation', time: '18:00', title: 'ä½å®¿: é•·é‡æ—¥èˆªé…’åº—', desc: 'æˆ– Sotetsu Fresaã€‚è¨‚å–®: 6128676866-PIN:0175', location: 'Hotel Jal City Nagano', bookingCode: '6128676866', cost: 36402 },
                ]
            },
            {
                id: 'day6', date: '5/15 (äº”)', title: 'é•·é‡ â†’ æ±äº¬',
                location: 'æ±äº¬',
                weather: { icon: 'fa-city', text: 'éƒ½å¸‚è§€å…‰', alert: false },
                events: [
                    { id: 'e6-1', type: 'transport', time: '09:00', title: 'æ–°å¹¹ç·š â†’ æ±äº¬', desc: 'åŒ—é™¸æ–°å¹¹ç·šï¼Œç´„1.5å°æ™‚ã€‚', location: 'æ±äº¬è»Šç«™', cost: 8000 },
                    { id: 'e6-2', type: 'sight', time: '13:00', title: 'æ·ºè‰é›·é–€ & æ™´ç©ºå¡”', desc: 'æ±äº¬å¿…éŠåœ°æ¨™ã€‚', location: 'é›·é–€' },
                    { id: 'e6-3', type: 'food', time: '18:00', title: 'æ±äº¬æ™šé¤', desc: 'ä¸Šé‡/æ·ºè‰ç¾é£Ÿã€‚', location: 'ä¸Šé‡' },
                    { id: 'e6-4', type: 'accommodation', time: '20:00', title: 'ä½å®¿: ä¸Šé‡ç¬¬ä¸€éƒ½å¸‚é…’åº—', desc: 'è¨‚å–®: 5038002965-PIN:6928', location: 'Ueno First City Hotel', bookingCode: '5038002965', cost: 63812 },
                ]
            },
            {
                id: 'day7', date: '5/16 (å…­)', title: 'æ±äº¬è‡ªç”±è¡Œ',
                location: 'æ±äº¬',
                weather: { icon: 'fa-bag-shopping', text: 'è³¼ç‰©æ—¥', alert: false },
                events: [
                    { id: 'e7-1', type: 'activity', time: '10:00', title: 'æ–¹æ¡ˆ1: ä¸Šé‡å‹•ç‰©åœ’', desc: 'é˜¿ç¾æ©«ç”º+æ·ºè‰é›·é–€ã€‚', location: 'ä¸Šé‡å‹•ç‰©åœ’' },
                    { id: 'e7-2', type: 'activity', time: '10:00', title: 'æ–¹æ¡ˆ2: æ™´ç©ºå¡”', desc: 'æ±äº¬æ™´ç©ºå¡”+æŠ¼ä¸Šç¾é£Ÿè¡—ã€‚', location: 'æ±äº¬æ™´ç©ºå¡”' },
                    { id: 'e7-3', type: 'activity', time: '10:00', title: 'æ–¹æ¡ˆ3: å°å ´ä¸€æ—¥éŠ', desc: 'æ¨‚é«˜æ¢ç´¢ä¸­å¿ƒã€DiverCityã€é‹¼å½ˆã€‚', location: 'å°å ´' },
                    { id: 'e7-4', type: 'accommodation', time: '20:00', title: 'ä½å®¿: æˆç”°æ±æ­¦æ©Ÿå ´é…’åº—', desc: 'ç§»å‹•è‡³æ©Ÿå ´é™„è¿‘ã€‚è¨‚å–®: 5068249636-PIN:5297', location: 'Narita Tobu Hotel Airport', bookingCode: '5068249636', cost: 36086 },
                ]
            },
            {
                id: 'day8', date: '5/17 (æ—¥)', title: 'æˆç”° â†’ é«˜é›„',
                location: 'æˆç”°',
                weather: { icon: 'fa-plane-departure', text: 'å›ç¨‹', alert: false },
                events: [
                    { id: 'e8-1', type: 'transport', time: '09:00', title: 'å‰å¾€æ©Ÿå ´', desc: 'é£¯åº—æ¥é§è»Šæˆ–é›»è»Šã€‚', location: 'æˆç”°æ©Ÿå ´' },
                    { id: 'e8-2', type: 'activity', time: '10:00', title: 'æ©Ÿå ´æ¡è²·', desc: 'æœ€å¾Œè¡åˆºä¼´æ‰‹ç¦®ã€‚', location: 'æˆç”°æ©Ÿå ´å…ç¨…åº—' },
                    { id: 'e8-3', type: 'transport', time: '13:30', title: 'IT 281 èµ·é£›', desc: 'æˆç”° â†’ é«˜é›„ (16:40 æŠµé”)ã€‚', location: 'æˆç”°æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ' },
                ]
            }
        ];

        // =========================================
        // Components
        // =========================================

        const NavigateButton = ({ location }) => {
            if (!location) return null;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
            return (
                <a href={mapsUrl} target="_blank" rel="noopener noreferrer" 
                   className="inline-flex items-center gap-1.5 bg-sky-200 text-sky-700 text-xs px-3 py-1.5 rounded-2xl font-bold shadow-sm hover:bg-sky-300 active:scale-95 transition-all mt-2 no-underline border border-sky-300">
                    <i className="fa-solid fa-location-arrow text-[0.7rem]"></i>
                    <span>Go!</span>
                </a>
            );
        };

        const Tag = ({ type, text }) => {
            let colorClass = "tag-base bg-slate-100 text-slate-600 border-slate-200";
            if (type === 'must-eat') colorClass = "tag-base tag-food";
            if (type === 'must-buy') colorClass = "tag-base tag-buy";
            if (type === 'transport') colorClass = "tag-base tag-transport";
            if (type === 'highlight') colorClass = "tag-base tag-highlight";
            if (type === 'code') colorClass = "tag-base tag-code";
            if (type === 'cost') colorClass = "tag-base tag-cost";
            return <span className={colorClass}>{text}</span>;
        };

        const EditModal = ({ event, onClose, onSave }) => {
            const [title, setTitle] = useState(event.title || '');
            const [time, setTime] = useState(event.time || '');
            const [location, setLocation] = useState(event.location || '');
            const [bookingCode, setBookingCode] = useState(event.bookingCode || '');
            const [cost, setCost] = useState(event.cost || '');
            const [note, setNote] = useState(event.note || '');

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl border-4 border-pink-200 animate-[bounce_0.2s_ease-out] max-h-[90vh] overflow-y-auto">
                        <h3 className="text-xl font-bold text-pink-500 mb-4 flex items-center gap-2">
                            <i className="fa-solid fa-pen-to-square"></i> ç·¨è¼¯è¡Œç¨‹
                        </h3>
                        <div className="space-y-3">
                             <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">æ™‚é–“</label>
                                <input type="text" value={time} onChange={(e) => setTime(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">æ¨™é¡Œ (è¡Œç¨‹/é¤å»³)</label>
                                <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400 font-bold text-slate-700" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">å°èˆªåœ°é» (çµ¦ Google Maps)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2 text-slate-400"><i className="fa-solid fa-map-pin"></i></span>
                                    <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl pl-8 pr-3 py-2 focus:border-pink-400" />
                                </div>
                            </div>
                            <div className="border-t border-dashed border-slate-200 my-2"></div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">è¨‚ä½ä»£ç¢¼ / ç¥¨è™Ÿ</label>
                                <input type="text" value={bookingCode} onChange={(e) => setBookingCode(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">è²»ç”¨ (è»Šè³‡/é–€ç¥¨)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2 text-slate-400">Â¥</span>
                                    <input type="number" value={cost} onChange={(e) => setCost(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl pl-7 pr-3 py-2 focus:border-pink-400" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">å‚™è¨»ç­†è¨˜</label>
                                <textarea value={note} onChange={(e) => setNote(e.target.value)} rows="2" className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400 resize-none"></textarea>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-2.5 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
                            <button onClick={() => onSave({ title, time, location, bookingCode, cost, note })} className="flex-1 py-2.5 rounded-xl font-bold text-white bg-pink-400 hover:bg-pink-500 shadow-md shadow-pink-200 transition-colors">å„²å­˜</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TimelineItem = ({ event, isLast, onEdit }) => {
            let icon = 'fa-circle';
            let iconColor = 'text-slate-400';
            let iconBg = 'bg-slate-100';

            switch(event.type) {
                case 'transport': icon = 'fa-train-subway'; iconColor = 'text-blue-500'; iconBg = 'bg-blue-100'; break;
                case 'food': icon = 'fa-utensils'; iconColor = 'text-orange-500'; iconBg = 'bg-orange-100'; break;
                case 'sight': icon = 'fa-camera'; iconColor = 'text-teal-600'; iconBg = 'bg-teal-100'; break;
                case 'accommodation': icon = 'fa-bed'; iconColor = 'text-purple-500'; iconBg = 'bg-purple-100'; break;
                case 'activity': icon = 'fa-star'; iconColor = 'text-yellow-500'; iconBg = 'bg-yellow-100'; break;
            }

            return (
                <div className="relative pl-4 pb-8 last:pb-2 group">
                    {!isLast && <div className="absolute left-[27px] top-8 bottom-0 w-0.5 bg-slate-200 border-l-2 border-dotted border-slate-300 h-full"></div>}
                    <div className="flex gap-4">
                        <div className={`relative z-10 w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 border-2 border-white shadow-md ${iconBg} ${iconColor}`}>
                            <i className={`fa-solid ${icon} text-sm`}></i>
                        </div>
                        <div className="flex-1 pt-0.5">
                            <div className="flex items-baseline justify-between mb-1">
                                <span className="font-bold text-slate-700 text-lg">{event.title}</span>
                                <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg">{event.time}</span>
                            </div>
                            <div className="mb-2">
                                {event.highlights && event.highlights.map((tag, idx) => (
                                    <Tag key={`hl-${idx}`} type={tag.type} text={tag.text} />
                                ))}
                                {event.bookingCode && <Tag type="code" text={`ä»£ç¢¼: ${event.bookingCode}`} />}
                                {event.cost && <Tag type="cost" text={`Â¥${event.cost}`} />}
                            </div>
                            <p className="text-sm text-slate-500 leading-relaxed mb-2">{event.desc}</p>
                            {event.note && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-xs text-yellow-800 mb-2">
                                    <i className="fa-regular fa-note-sticky mr-1"></i> {event.note}
                                </div>
                            )}
                            <div className="flex items-center gap-2">
                                <NavigateButton location={event.location} />
                                <button onClick={() => onEdit(event)} className="mt-2 text-xs text-pink-400 font-bold px-3 py-1.5 rounded-2xl border border-pink-200 hover:bg-pink-50 transition-colors flex items-center gap-1">
                                    <i className="fa-solid fa-pen"></i> ç·¨è¼¯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DayCard = ({ day, isExpanded, onToggle, onUpdateEvent }) => {
            const [editingEvent, setEditingEvent] = useState(null);
            const handleSave = (data) => {
                onUpdateEvent(day.id, editingEvent.id, data);
                setEditingEvent(null);
            };

            return (
                <div className="app-card mb-5">
                    <div onClick={onToggle} className="p-4 flex items-center justify-between cursor-pointer active:bg-pink-50/50">
                        <div>
                            <div className="text-xs font-bold text-pink-500 uppercase tracking-wider mb-0.5 flex items-center gap-1">
                                <i className="fa-regular fa-calendar-check"></i> {day.date}
                            </div>
                            <h2 className="text-xl font-black text-slate-700">{day.title}</h2>
                        </div>
                        <div className={`w-8 h-8 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                            <i className="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                    {isExpanded && (
                        <div>
                            <div className={`mx-4 px-4 py-3 rounded-xl flex items-center justify-between text-sm font-bold border-2 ${day.weather.alert ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-sky-50 text-sky-600 border-sky-100'}`}>
                                <div className="flex items-center gap-2">
                                    <i className={`fa-solid ${day.weather.icon} text-lg`}></i>
                                    <span>{day.weather.text}</span>
                                </div>
                                {day.weather.alert && <span className="text-[10px] bg-amber-200 text-amber-800 px-2 py-1 rounded-full animate-bounce">æ³¨æ„</span>}
                            </div>
                            <div className="p-4">
                                {day.events.map((event, index) => (
                                    <TimelineItem key={event.id} event={event} isLast={index === day.events.length - 1} onEdit={setEditingEvent} />
                                ))}
                            </div>
                        </div>
                    )}
                    {editingEvent && <EditModal event={editingEvent} onClose={() => setEditingEvent(null)} onSave={handleSave} />}
                </div>
            );
        };

        const ToolsView = ({ daysData, budgetData, onUpdateBudget, onResetData }) => {
            // è¨ˆç®—å¾è¡Œç¨‹ä¸­è¼¸å…¥çš„ç¸½è²»ç”¨
            const itineraryCost = daysData.reduce((total, day) => {
                return total + day.events.reduce((dayTotal, event) => {
                    return dayTotal + (parseInt(event.cost) || 0);
                }, 0);
            }, 0);

            const totalSpent = (budgetData?.manualSpent || 0) + itineraryCost;
            const remaining = (budgetData?.total || 0) - totalSpent;
            const percent = Math.min(100, (totalSpent / (budgetData?.total || 1)) * 100);

            const updateManualSpent = (amount) => {
                if (onUpdateBudget) {
                    onUpdateBudget({ ...budgetData, manualSpent: (budgetData?.manualSpent || 0) + amount });
                }
            };

            const resetBudget = () => {
                if (onUpdateBudget) {
                    onUpdateBudget({ ...budgetData, manualSpent: 0 });
                }
            };

            return (
                <div className="space-y-6 pb-24 p-4">
                    <a href="https://www.vjw.digital.go.jp/" target="_blank" rel="noopener noreferrer" 
                       className="block bg-gradient-to-r from-pink-400 to-rose-400 rounded-3xl p-1 shadow-lg transform active:scale-95 transition-transform">
                        <div className="bg-white/10 rounded-[1.3rem] p-4 flex items-center justify-between text-white">
                            <div>
                                <div className="text-xs font-bold opacity-90 mb-1">å…¥å¢ƒå¿…å‚™</div>
                                <div className="text-xl font-black">Visit Japan Web</div>
                            </div>
                            <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i className="fa-solid fa-qrcode text-xl"></i>
                            </div>
                        </div>
                    </a>

                    <div className="app-card p-6 border-pink-100">
                         <div className="flex justify-between items-center mb-4">
                             <h3 className="text-lg font-black text-slate-700 flex items-center gap-2">
                                <i className="fa-solid fa-coins text-yellow-400"></i> é ç®—éŒ¢åŒ…
                             </h3>
                             <button onClick={resetBudget} className="text-xs text-slate-400 hover:text-pink-500 font-bold bg-slate-100 px-2 py-1 rounded-lg">é‡ç½®æ‰‹å‹•</button>
                         </div>
                        
                        <div className="mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div className="flex justify-between text-sm mb-2">
                                <span className="text-slate-500 font-bold">å·²æ”¯å‡º (è¡Œç¨‹+æ‰‹å‹•)</span>
                                <span className="font-black text-slate-700 text-lg">Â¥{totalSpent.toLocaleString()}</span>
                            </div>
                            <div className="w-full bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                                <div className="bg-gradient-to-r from-yellow-300 to-orange-400 h-4 rounded-full transition-all duration-500 shadow-[0_2px_5px_rgba(251,146,60,0.5)]" style={{width: `${percent}%`}}></div>
                            </div>
                            <div className="text-right mt-1">
                                <span className="text-xs text-slate-400 font-bold">å‰©é¤˜ Â¥{remaining.toLocaleString()}</span>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3">
                            <button onClick={() => updateManualSpent(1000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+Â¥1,000</button>
                            <button onClick={() => updateManualSpent(5000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+Â¥5,000</button>
                            <button onClick={() => updateManualSpent(10000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+Â¥10,000</button>
                        </div>
                        <div className="mt-3 text-[10px] text-center text-slate-400">*ç·¨è¼¯è¡Œç¨‹ä¸­çš„è²»ç”¨æœƒè‡ªå‹•åŠ ç¸½å–”ï¼</div>
                    </div>

                    <div className="app-card p-6 border-blue-100">
                        <h3 className="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                            <i className="fa-solid fa-phone-volume text-blue-400"></i> ç·Šæ€¥è¯çµ¡
                        </h3>
                        <div className="space-y-3">
                            <div className="flex justify-between items-center py-2 border-b border-dashed border-slate-200">
                                <span className="text-slate-500 text-sm font-bold">å ±è­¦ / æ•‘è­·è»Š</span>
                                <span className="font-mono font-black text-slate-700 text-lg">110 / 119</span>
                            </div>
                            <div className="flex justify-between items-center py-2 border-b border-dashed border-slate-200">
                                <span className="text-slate-500 text-sm font-bold">é§æ—¥ä»£è¡¨è™•</span>
                                <span className="font-mono font-bold text-slate-700 select-all">+81-3-3280-7811</span>
                            </div>
                        </div>
                    </div>

                    {/* è³‡æ–™é‡ç½®å€ */}
                    <div className="mt-8 border-t border-slate-200 pt-6">
                        <button onClick={onResetData} className="w-full py-3 bg-rose-50 text-rose-500 font-bold rounded-2xl border-2 border-rose-100 hover:bg-rose-100 active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i className="fa-solid fa-rotate-right"></i>
                            âš ï¸ å¼·åˆ¶é‡ç½®ç‚ºã€ŒåŒ—é™¸æ±äº¬ã€è¡Œç¨‹ (è¦†è“‹èˆŠæª”)
                        </button>
                        <p className="text-center text-[10px] text-slate-400 mt-2">å¦‚æœçœ‹åˆ°çš„è³‡æ–™é‚„æ˜¯èˆŠçš„ï¼Œè«‹æŒ‰æ­¤æŒ‰éˆ•</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [days, setDays] = useState(null); 
            const [budget, setBudget] = useState({ total: 200000, manualSpent: 0 });
            const [expandedDay, setExpandedDay] = useState('day1');
            const [isLoading, setIsLoading] = useState(true);
            const [isLocalMode, setIsLocalMode] = useState(false);

            // åˆå§‹åŒ–èˆ‡èªè­‰é‚è¼¯
            useEffect(() => {
                const initAuth = async () => {
                    // 1. æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°é–‹ç™¼/æœªå¡«å¯« Key çš„ç‹€æ…‹
                    if (firebaseConfig.apiKey === "ä½ çš„_API_KEY") {
                        console.warn("åµæ¸¬åˆ°æœªè¨­å®š Firebase Keyï¼Œåˆ‡æ›ç‚ºæœ¬åœ°æ¨¡å¼ (Local Storage)ã€‚");
                        setIsLocalMode(true);
                        
                        // æœ¬åœ°æ¨¡å¼ï¼šç›´æ¥è®€å– LocalStorage
                        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            setDays(data.days);
                            setBudget(data.budget);
                        } else {
                            setDays(defaultItinerary);
                        }
                        setIsLoading(false);
                        return;
                    }

                    // 2. å˜—è©¦ Firebase ç™»å…¥
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth éŒ¯èª¤:", error);
                        // ç™»å…¥å¤±æ•—ä¹Ÿåˆ‡å›æœ¬åœ°æ¨¡å¼ï¼Œé¿å…ç•«é¢å¡ä½
                        setIsLocalMode(true);
                        setDays(defaultItinerary);
                        setIsLoading(false);
                    }
                };

                initAuth();

                // 3. ç›£è½ç™»å…¥ç‹€æ…‹ (åƒ…åœ¨éæœ¬åœ°æ¨¡å¼ä¸‹)
                const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                    if (user && firebaseConfig.apiKey !== "ä½ çš„_API_KEY") {
                        // ä½¿ç”¨æ­£ç¢ºçš„ Public Data è·¯å¾‘: artifacts/appId/public/data/trips/shared_japan_2025
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        
                        try {
                            const docSnap = await getDoc(docRef);
                            if (!docSnap.exists()) {
                                await setDoc(docRef, {
                                    days: defaultItinerary,
                                    budget: { total: 200000, manualSpent: 0 }
                                });
                            }

                            const unsubscribeSnapshot = onSnapshot(docRef, (doc) => {
                                if (doc.exists()) {
                                    const data = doc.data();
                                    setDays(data.days);
                                    if (data.budget) setBudget(data.budget);
                                }
                                setIsLoading(false);
                            });
                            return () => unsubscribeSnapshot();
                        } catch (e) {
                            console.error("Firestore è®€å–éŒ¯èª¤:", e);
                            setIsLocalMode(true);
                            setDays(defaultItinerary);
                            setIsLoading(false);
                        }
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            // å¼·åˆ¶é‡ç½®è³‡æ–™ (æ¸…é™¤é›²ç«¯èˆŠæª”)
            const handleResetData = async () => {
                if (!confirm("ç¢ºå®šè¦é‡ç½®å—ï¼Ÿé€™æœƒè¦†è“‹æ‰é›²ç«¯ä¸Šç›®å‰çš„èˆŠè¡Œç¨‹ï¼Œè®Šå›é è¨­çš„ã€ŒåŒ—é™¸æ±äº¬ã€è¡Œç¨‹ã€‚")) return;
                
                const newBudget = { total: 200000, manualSpent: 0 };
                // 1. å…ˆæ›´æ–°ç•«é¢
                setDays(defaultItinerary);
                setBudget(newBudget);

                // 2. æ›´æ–°å„²å­˜ (æœ¬åœ°æˆ–é›²ç«¯)
                if (isLocalMode) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ days: defaultItinerary, budget: newBudget }));
                    alert("æœ¬åœ°è³‡æ–™å·²é‡ç½®ï¼");
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await setDoc(docRef, { 
                            days: defaultItinerary, 
                            budget: newBudget 
                        });
                        alert("é›²ç«¯è³‡æ–™å·²æˆåŠŸé‡ç½®ç‚ºæ–°è¡Œç¨‹ï¼");
                    } catch (e) {
                        console.error("é‡ç½®å¤±æ•—:", e);
                        alert("é‡ç½®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚");
                    }
                }
            };

            // æ›´æ–°äº‹ä»¶
            const handleUpdateEvent = async (dayId, eventId, newData) => {
                if (!days) return;
                
                const updatedDays = days.map(day => {
                    if (day.id !== dayId) return day;
                    return {
                        ...day,
                        events: day.events.map(ev => {
                            if (ev.id !== eventId) return ev;
                            return { ...ev, ...newData };
                        })
                    };
                });
                
                setDays(updatedDays);

                if (isLocalMode) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ days: updatedDays, budget }));
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await updateDoc(docRef, { days: updatedDays });
                    } catch (e) {
                        console.error("æ›´æ–°å¤±æ•—:", e);
                    }
                }
            };

            // æ›´æ–°é ç®—
            const handleUpdateBudget = async (newBudget) => {
                setBudget(newBudget);
                
                if (isLocalMode) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ days, budget: newBudget }));
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await updateDoc(docRef, { budget: newBudget });
                    } catch (e) {
                        console.error("é ç®—æ›´æ–°å¤±æ•—:", e);
                    }
                }
            };

            useEffect(() => {
                window.scrollTo(0, 0);
            }, [activeTab]);

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-[#fff1f2] flex flex-col items-center justify-center text-pink-400 gap-4">
                        <i className="fa-solid fa-cloud text-6xl chiikawa-bounce"></i>
                        <p className="font-bold text-lg">è¼‰å…¥ä¸­...</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#fff1f2] overflow-x-hidden">
                    {/* v2.6 æˆåŠŸé€šçŸ¥æ©«å¹… */}
                    <div className="bg-indigo-500 text-white text-xs font-bold text-center py-2 px-4 shadow-md animate-pulse sticky top-0 z-50">
                        <i className="fa-solid fa-check-circle mr-1"></i>
                        ç‰ˆæœ¬ 2.6 æ›´æ–°æˆåŠŸï¼ (è«‹è‡³å·¥å…·é é‡ç½®é›²ç«¯è³‡æ–™)
                    </div>

                    <header className="sticky top-8 z-40 bg-[#fff1f2]/90 backdrop-blur-md px-5 py-4 border-b-2 border-pink-100 flex justify-between items-center shadow-sm">
                        <h1 className="text-2xl font-black text-slate-700 tracking-tight flex items-center gap-2">
                            <span className="text-pink-500 text-3xl">âœ¨</span> 
                            <span>Japan<span className="text-pink-400">Trip</span></span>
                        </h1>
                        <div className="w-10 h-10 rounded-full bg-white border-2 border-pink-200 flex items-center justify-center shadow-sm">
                            <i className="fa-solid fa-face-smile text-pink-400 text-xl"></i>
                        </div>
                    </header>

                    {isLocalMode && (
                        <div className="bg-orange-100 text-orange-700 text-xs font-bold text-center py-2 px-4">
                            <i className="fa-solid fa-triangle-exclamation mr-1"></i>
                            ç›®å‰ç‚ºé è¦½/é›¢ç·šæ¨¡å¼ (è³‡æ–™åƒ…å­˜æ–¼æ­¤è£ç½®)
                        </div>
                    )}

                    <main className="pt-6">
                        {activeTab === 'itinerary' ? (
                            <div className="px-4">
                                {days && days.map(day => (
                                    <DayCard 
                                        key={day.id} 
                                        day={day} 
                                        isExpanded={expandedDay === day.id}
                                        onToggle={() => setExpandedDay(expandedDay === day.id ? null : day.id)}
                                        onUpdateEvent={handleUpdateEvent}
                                    />
                                ))}
                                <div className="text-center text-pink-300 font-bold text-sm mt-8 mb-4">
                                    ~ æ—…é€”æ„‰å¿« v2.6 (é›²ç«¯é‡ç½®ç‰ˆ) ~
                                </div>
                            </div>
                        ) : (
                            <ToolsView 
                                daysData={days || []} 
                                budgetData={budget} 
                                onUpdateBudget={handleUpdateBudget} 
                                onResetData={handleResetData}
                            />
                        )}
                    </main>

                    <nav className="fixed bottom-6 left-6 right-6 bg-white/95 backdrop-blur rounded-[2rem] shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white z-50 max-w-[calc(28rem-3rem)] mx-auto">
                        <div className="flex justify-around items-center h-16">
                            <button 
                                onClick={() => setActiveTab('itinerary')}
                                className={`flex items-center gap-2 px-6 py-2 rounded-full transition-all duration-300 ${activeTab === 'itinerary' ? 'bg-pink-100 text-pink-500 font-bold' : 'text-slate-400 font-medium'}`}
                            >
                                <i className="fa-solid fa-map-location-dot text-lg"></i>
                                {activeTab === 'itinerary' && <span>è¡Œç¨‹</span>}
                            </button>
                            <div className="w-px h-8 bg-slate-100"></div>
                            <button 
                                onClick={() => setActiveTab('tools')}
                                className={`flex items-center gap-2 px-6 py-2 rounded-full transition-all duration-300 ${activeTab === 'tools' ? 'bg-pink-100 text-pink-500 font-bold' : 'text-slate-400 font-medium'}`}
                            >
                                <i className="fa-solid fa-suitcase text-lg"></i>
                                {activeTab === 'tools' && <span>å·¥å…·</span>}
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>