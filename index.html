<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chiikawa Trip</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fff1f2">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1908/1908344.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Kosugi Maru', -apple-system, sans-serif;
            background-color: #fff1f2;
            background-image: radial-gradient(#fecdd3 1px, transparent 1px);
            background-size: 20px 20px;
            color: #475569;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(251, 113, 133, 0.15);
            border: 2px solid #fff;
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
        }
        .app-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: linear-gradient(to right, #f9a8d4, #f472b6);
        }

        .tag-base { @apply px-2.5 py-1 rounded-full text-xs font-bold mr-1.5 mb-1 inline-block border-2 shadow-sm; }
        .tag-food { @apply bg-orange-100 text-orange-600 border-orange-200; }
        .tag-buy { @apply bg-rose-100 text-rose-600 border-rose-200; }
        .tag-transport { @apply bg-blue-100 text-blue-600 border-blue-200; }
        .tag-highlight { @apply bg-yellow-100 text-yellow-700 border-yellow-200; }
        .tag-code { @apply bg-purple-100 text-purple-600 border-purple-200 font-mono tracking-wider; }
        .tag-cost { @apply bg-emerald-100 text-emerald-600 border-emerald-200; }

        .btn-cute {
            @apply active:scale-95 transition-transform rounded-2xl font-bold shadow-md border-b-4 active:border-b-0 active:translate-y-1;
        }

        /* Loading 動畫 */
        .chiikawa-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 這裡改用 module 模式來支援 Firebase import -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, collection } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const { useState, useEffect, useRef } = React;

        // =========================================
        // 1. 設定 Firebase Config
        // =========================================
        const getFirebaseConfig = () => {
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    return JSON.parse(__firebase_config);
                }
            } catch (e) {
                console.log("Not in preview mode or config invalid");
            }
            
            return {
                apiKey: "AIzaSyCpOfvR92qEkDHDZio8jZ4VR-tru2MScSQ",
                authDomain: "japan-trip-2025-5f3a3.firebaseapp.com",
                projectId: "japan-trip-2025-5f3a3",
                storageBucket: "japan-trip-2025-5f3a3.firebasestorage.app",
                messagingSenderId: "828851638958",
                appId: "1:828851638958:web:59bad47902fe08671b933f"
            };
        };

        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // 路徑: artifacts/{appId}/public/data/trips/shared_japan_2025
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TRIP_DOC_PATH = ['artifacts', appId, 'public', 'data', 'trips', 'shared_japan_2025'];

        // =========================================
        // 新版資料結構 (根據使用者上傳的 CSV 整合)
        // =========================================
        const defaultItinerary = [
            {
                id: 'day1', date: '5/10 (日)', title: '桃園 → 小松 → 金澤',
                location: '金澤',
                weather: { icon: 'fa-plane', text: '出發日', alert: false },
                events: [
                    { id: 'e1-1', type: 'transport', time: '12:10', title: 'IT 252 起飛', desc: '桃園 → 小松機場 (16:05 抵達)。', location: '桃園國際機場' },
                    { id: 'e1-2', type: 'transport', time: '17:00', title: '機場巴士 → 金澤', desc: '出關後左轉搭車。約40分。', location: '小松機場', cost: 1150 },
                    { id: 'e1-3', type: 'food', time: '18:30', title: '金澤晚餐', desc: '金澤車站周邊美食。', location: '金澤車站' },
                    { id: 'e1-4', type: 'accommodation', time: '20:00', title: '住宿: 金澤大酒店', desc: '或 MYSTAYS 金澤精品酒店。', location: 'Kanazawa Hotel', bookingCode: '5949989585-PIN:3738', cost: 60554, note: '5/8前可取消' },
                ]
            },
            {
                id: 'day2', date: '5/11 (一)', title: '金澤古都一日遊',
                location: '金澤',
                weather: { icon: 'fa-sun', text: '適合拍照', alert: false },
                events: [
                    { id: 'e2-1', type: 'transport', time: '09:00', title: 'Loop Bus 一日券', desc: 'JR 金澤站購買。', location: '金澤車站', cost: 600 },
                    { id: 'e2-2', type: 'sight', time: '09:30', title: '兼六園 & 金澤城', desc: '建議由桂坂口進入，早上光線最美。', location: '兼六園' },
                    { id: 'e2-3', type: 'food', time: '12:00', title: '午餐: 近江町市場', desc: '必吃海鮮丼 (山さん壽司、もりもり寿司)。', location: '近江町市場' },
                    { id: 'e2-4', type: 'sight', time: '14:00', title: '東茶屋街', desc: '箔一金箔冰淇淋、久連波和菓子。', location: '東茶屋街' },
                    { id: 'e2-5', type: 'sight', time: '16:00', title: '長町武家屋敷', desc: '古色古香的武士街道。', location: '長町武家屋敷跡' },
                    { id: 'e2-6', type: 'food', time: '18:00', title: '晚餐: 金澤咖哩', desc: '濃郁黑咖哩。', location: 'Go Go Curry' },
                    { id: 'e2-7', type: 'accommodation', time: '20:00', title: '住宿: 金澤續住', desc: '同第一晚。', location: 'Kanazawa Hotel' },
                ]
            },
            {
                id: 'day3', date: '5/12 (二)', title: '合掌村 → 飛驒高山',
                location: '高山',
                weather: { icon: 'fa-car', text: '自駕日', alert: false },
                events: [
                    { id: 'e3-1', type: 'transport', time: '09:00', title: '租車出發', desc: '自駕前往白川鄉。', location: '金澤車站租車' },
                    { id: 'e3-2', type: 'sight', time: '10:30', title: '白川鄉合掌村', desc: '世界遺產童話村落。', location: '白川鄉' },
                    { id: 'e3-3', type: 'food', time: '12:30', title: '午餐: 合掌村', desc: '五平餅、蕎麥麵。', location: '白川鄉' },
                    { id: 'e3-4', type: 'transport', time: '14:30', title: '前往高山', desc: '前往飛驒高山古街。', location: '高山三町筋' },
                    { id: 'e3-5', type: 'sight', time: '15:30', title: '高山古街', desc: '飛驒牛壽司、味增串。', location: '高山老街' },
                    { id: 'e3-6', type: 'food', time: '18:00', title: '晚餐: 飛驒牛一頭家', desc: '頂級飛驒牛燒肉。', location: '飛驒牛一頭家' },
                    { id: 'e3-7', type: 'accommodation', time: '20:00', title: '住宿: Residence 高山', desc: '或 fav Hide 高山。訂單: 6171736740-PIN:1772', location: 'Residence Hotel Takayama Station', bookingCode: '6171736740', cost: 55869 },
                ]
            },
            {
                id: 'day4', date: '5/13 (三)', title: '高山朝市 → 富山',
                location: '富山',
                weather: { icon: 'fa-cloud-sun', text: '移動日', alert: false },
                events: [
                    { id: 'e4-1', type: 'sight', time: '08:00', title: '宮川朝市', desc: '清晨散步，逛市集。', location: '宮川朝市' },
                    { id: 'e4-2', type: 'transport', time: '14:00', title: '前往富山', desc: 'JR高山本線 (約1.5小時)。', location: '富山車站', cost: 2860 },
                    { id: 'e4-3', type: 'accommodation', time: '16:00', title: '住宿: 東橫INN 富山站', desc: '新幹線口2號店。訂單: 5361206-7', location: 'Toyoko Inn Toyama-eki Shinkansen-guchi No.2', bookingCode: '5361206-7', cost: 40870 },
                    { id: 'e4-4', type: 'food', time: '18:00', title: '富山晚餐', desc: '白蝦料理、富山黑拉麵。', location: '富山車站' },
                ]
            },
            {
                id: 'day5', date: '5/14 (四)', title: '穿越立山黑部',
                location: '長野',
                weather: { icon: 'fa-snowflake', text: '高山氣候', alert: true },
                events: [
                    { id: 'e5-1', type: 'transport', time: '07:00', title: '★ 寄行李', desc: '將大行李寄往長野/東京。', location: '富山車站' },
                    { id: 'e5-2', type: 'transport', time: '08:00', title: '電鐵 富山→立山站', desc: '約1小時。', location: '立山站', cost: 1230 },
                    { id: 'e5-3', type: 'sight', time: '10:00', title: '立山黑部穿越', desc: '美女平、室堂(雪壁)、大觀峰、黑部水庫。', location: '室堂' },
                    { id: 'e5-4', type: 'transport', time: '15:00', title: '扇澤 → 長野站', desc: 'ALPICO巴士，約1小時40分。', location: '扇澤站', cost: 2000 },
                    { id: 'e5-5', type: 'accommodation', time: '18:00', title: '住宿: 長野日航酒店', desc: '或 Sotetsu Fresa。訂單: 6128676866-PIN:0175', location: 'Hotel Jal City Nagano', bookingCode: '6128676866', cost: 36402 },
                ]
            },
            {
                id: 'day6', date: '5/15 (五)', title: '長野 → 東京',
                location: '東京',
                weather: { icon: 'fa-city', text: '都市觀光', alert: false },
                events: [
                    { id: 'e6-1', type: 'transport', time: '09:00', title: '新幹線 → 東京', desc: '北陸新幹線，約1.5小時。', location: '東京車站', cost: 8000 },
                    { id: 'e6-2', type: 'sight', time: '13:00', title: '淺草雷門 & 晴空塔', desc: '東京必遊地標。', location: '雷門' },
                    { id: 'e6-3', type: 'food', time: '18:00', title: '東京晚餐', desc: '上野/淺草美食。', location: '上野' },
                    { id: 'e6-4', type: 'accommodation', time: '20:00', title: '住宿: 上野第一都市酒店', desc: '訂單: 5038002965-PIN:6928', location: 'Ueno First City Hotel', bookingCode: '5038002965', cost: 63812 },
                ]
            },
            {
                id: 'day7', date: '5/16 (六)', title: '東京自由行',
                location: '東京',
                weather: { icon: 'fa-bag-shopping', text: '購物日', alert: false },
                events: [
                    { id: 'e7-1', type: 'activity', time: '10:00', title: '方案1: 上野動物園', desc: '阿美橫町+淺草雷門。', location: '上野動物園' },
                    { id: 'e7-2', type: 'activity', time: '10:00', title: '方案2: 晴空塔', desc: '東京晴空塔+押上美食街。', location: '東京晴空塔' },
                    { id: 'e7-3', type: 'activity', time: '10:00', title: '方案3: 台場一日遊', desc: '樂高探索中心、DiverCity、鋼彈。', location: '台場' },
                    { id: 'e7-4', type: 'accommodation', time: '20:00', title: '住宿: 成田東武機場酒店', desc: '移動至機場附近。訂單: 5068249636-PIN:5297', location: 'Narita Tobu Hotel Airport', bookingCode: '5068249636', cost: 36086 },
                ]
            },
            {
                id: 'day8', date: '5/17 (日)', title: '成田 → 高雄',
                location: '成田',
                weather: { icon: 'fa-plane-departure', text: '回程', alert: false },
                events: [
                    { id: 'e8-1', type: 'transport', time: '09:00', title: '前往機場', desc: '飯店接駁車或電車。', location: '成田機場' },
                    { id: 'e8-2', type: 'activity', time: '10:00', title: '機場採買', desc: '最後衝刺伴手禮。', location: '成田機場免稅店' },
                    { id: 'e8-3', type: 'transport', time: '13:30', title: 'IT 281 起飛', desc: '成田 → 高雄 (16:40 抵達)。', location: '成田機場第二航廈' },
                ]
            }
        ];

        // =========================================
        // Components
        // =========================================

        const NavigateButton = ({ location }) => {
            if (!location) return null;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
            return (
                <a href={mapsUrl} target="_blank" rel="noopener noreferrer" 
                   className="inline-flex items-center gap-1.5 bg-sky-200 text-sky-700 text-xs px-3 py-1.5 rounded-2xl font-bold shadow-sm hover:bg-sky-300 active:scale-95 transition-all mt-2 no-underline border border-sky-300">
                    <i className="fa-solid fa-location-arrow text-[0.7rem]"></i>
                    <span>Go!</span>
                </a>
            );
        };

        const Tag = ({ type, text }) => {
            let colorClass = "tag-base bg-slate-100 text-slate-600 border-slate-200";
            if (type === 'must-eat') colorClass = "tag-base tag-food";
            if (type === 'must-buy') colorClass = "tag-base tag-buy";
            if (type === 'transport') colorClass = "tag-base tag-transport";
            if (type === 'highlight') colorClass = "tag-base tag-highlight";
            if (type === 'code') colorClass = "tag-base tag-code";
            if (type === 'cost') colorClass = "tag-base tag-cost";
            return <span className={colorClass}>{text}</span>;
        };

        const EditModal = ({ event, onClose, onSave }) => {
            const [title, setTitle] = useState(event.title || '');
            const [time, setTime] = useState(event.time || '');
            const [location, setLocation] = useState(event.location || '');
            const [bookingCode, setBookingCode] = useState(event.bookingCode || '');
            const [cost, setCost] = useState(event.cost || '');
            const [note, setNote] = useState(event.note || '');

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl border-4 border-pink-200 animate-[bounce_0.2s_ease-out] max-h-[90vh] overflow-y-auto">
                        <h3 className="text-xl font-bold text-pink-500 mb-4 flex items-center gap-2">
                            <i className="fa-solid fa-pen-to-square"></i> 編輯行程
                        </h3>
                        <div className="space-y-3">
                             <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">時間</label>
                                <input type="text" value={time} onChange={(e) => setTime(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">標題 (行程/餐廳)</label>
                                <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400 font-bold text-slate-700" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">導航地點 (給 Google Maps)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2 text-slate-400"><i className="fa-solid fa-map-pin"></i></span>
                                    <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl pl-8 pr-3 py-2 focus:border-pink-400" />
                                </div>
                            </div>
                            <div className="border-t border-dashed border-slate-200 my-2"></div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">訂位代碼 / 票號</label>
                                <input type="text" value={bookingCode} onChange={(e) => setBookingCode(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">費用 (車資/門票)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2 text-slate-400">¥</span>
                                    <input type="number" value={cost} onChange={(e) => setCost(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl pl-7 pr-3 py-2 focus:border-pink-400" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">備註筆記</label>
                                <textarea value={note} onChange={(e) => setNote(e.target.value)} rows="2" className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400 resize-none"></textarea>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-2.5 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors">取消</button>
                            <button onClick={() => onSave({ title, time, location, bookingCode, cost, note })} className="flex-1 py-2.5 rounded-xl font-bold text-white bg-pink-400 hover:bg-pink-500 shadow-md shadow-pink-200 transition-colors">儲存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TimelineItem = ({ event, isLast, onEdit }) => {
            let icon = 'fa-circle';
            let iconColor = 'text-slate-400';
            let iconBg = 'bg-slate-100';

            switch(event.type) {
                case 'transport': icon = 'fa-train-subway'; iconColor = 'text-blue-500'; iconBg = 'bg-blue-100'; break;
                case 'food': icon = 'fa-utensils'; iconColor = 'text-orange-500'; iconBg = 'bg-orange-100'; break;
                case 'sight': icon = 'fa-camera'; iconColor = 'text-teal-600'; iconBg = 'bg-teal-100'; break;
                case 'accommodation': icon = 'fa-bed'; iconColor = 'text-purple-500'; iconBg = 'bg-purple-100'; break;
                case 'activity': icon = 'fa-star'; iconColor = 'text-yellow-500'; iconBg = 'bg-yellow-100'; break;
            }

            return (
                <div className="relative pl-4 pb-8 last:pb-2 group">
                    {!isLast && <div className="absolute left-[27px] top-8 bottom-0 w-0.5 bg-slate-200 border-l-2 border-dotted border-slate-300 h-full"></div>}
                    <div className="flex gap-4">
                        <div className={`relative z-10 w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 border-2 border-white shadow-md ${iconBg} ${iconColor}`}>
                            <i className={`fa-solid ${icon} text-sm`}></i>
                        </div>
                        <div className="flex-1 pt-0.5">
                            <div className="flex items-baseline justify-between mb-1">
                                <span className="font-bold text-slate-700 text-lg">{event.title}</span>
                                <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg">{event.time}</span>
                            </div>
                            <div className="mb-2">
                                {event.highlights && event.highlights.map((tag, idx) => (
                                    <Tag key={`hl-${idx}`} type={tag.type} text={tag.text} />
                                ))}
                                {event.bookingCode && <Tag type="code" text={`代碼: ${event.bookingCode}`} />}
                                {event.cost && <Tag type="cost" text={`¥${event.cost}`} />}
                            </div>
                            <p className="text-sm text-slate-500 leading-relaxed mb-2">{event.desc}</p>
                            {event.note && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-xs text-yellow-800 mb-2">
                                    <i className="fa-regular fa-note-sticky mr-1"></i> {event.note}
                                </div>
                            )}
                            <div className="flex items-center gap-2">
                                <NavigateButton location={event.location} />
                                <button onClick={() => onEdit(event)} className="mt-2 text-xs text-pink-400 font-bold px-3 py-1.5 rounded-2xl border border-pink-200 hover:bg-pink-50 transition-colors flex items-center gap-1">
                                    <i className="fa-solid fa-pen"></i> 編輯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DayCard = ({ day, isExpanded, onToggle, onUpdateEvent }) => {
            const [editingEvent, setEditingEvent] = useState(null);
            const handleSave = (data) => {
                onUpdateEvent(day.id, editingEvent.id, data);
                setEditingEvent(null);
            };

            return (
                <div className="app-card mb-5">
                    <div onClick={onToggle} className="p-4 flex items-center justify-between cursor-pointer active:bg-pink-50/50">
                        <div>
                            <div className="text-xs font-bold text-pink-500 uppercase tracking-wider mb-0.5 flex items-center gap-1">
                                <i className="fa-regular fa-calendar-check"></i> {day.date}
                            </div>
                            <h2 className="text-xl font-black text-slate-700">{day.title}</h2>
                        </div>
                        <div className={`w-8 h-8 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                            <i className="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                    {isExpanded && (
                        <div>
                            <div className={`mx-4 px-4 py-3 rounded-xl flex items-center justify-between text-sm font-bold border-2 ${day.weather.alert ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-sky-50 text-sky-600 border-sky-100'}`}>
                                <div className="flex items-center gap-2">
                                    <i className={`fa-solid ${day.weather.icon} text-lg`}></i>
                                    <span>{day.weather.text}</span>
                                </div>
                                {day.weather.alert && <span className="text-[10px] bg-amber-200 text-amber-800 px-2 py-1 rounded-full animate-bounce">注意</span>}
                            </div>
                            <div className="p-4">
                                {day.events.map((event, index) => (
                                    <TimelineItem key={event.id} event={event} isLast={index === day.events.length - 1} onEdit={setEditingEvent} />
                                ))}
                            </div>
                        </div>
                    )}
                    {editingEvent && <EditModal event={editingEvent} onClose={() => setEditingEvent(null)} onSave={handleSave} />}
                </div>
            );
        };

        const ToolsView = ({ daysData, budgetData, onUpdateBudget }) => {
            // 計算從行程中輸入的總費用
            const itineraryCost = daysData.reduce((total, day) => {
                return total + day.events.reduce((dayTotal, event) => {
                    return dayTotal + (parseInt(event.cost) || 0);
                }, 0);
            }, 0);

            const totalSpent = (budgetData?.manualSpent || 0) + itineraryCost;
            const remaining = (budgetData?.total || 0) - totalSpent;
            const percent = Math.min(100, (totalSpent / (budgetData?.total || 1)) * 100);

            const updateManualSpent = (amount) => {
                if (onUpdateBudget) {
                    onUpdateBudget({ ...budgetData, manualSpent: (budgetData?.manualSpent || 0) + amount });
                }
            };

            const resetBudget = () => {
                if (onUpdateBudget) {
                    onUpdateBudget({ ...budgetData, manualSpent: 0 });
                }
            };

            return (
                <div className="space-y-6 pb-24 p-4">
                    <a href="https://www.vjw.digital.go.jp/" target="_blank" rel="noopener noreferrer" 
                       className="block bg-gradient-to-r from-pink-400 to-rose-400 rounded-3xl p-1 shadow-lg transform active:scale-95 transition-transform">
                        <div className="bg-white/10 rounded-[1.3rem] p-4 flex items-center justify-between text-white">
                            <div>
                                <div className="text-xs font-bold opacity-90 mb-1">入境必備</div>
                                <div className="text-xl font-black">Visit Japan Web</div>
                            </div>
                            <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i className="fa-solid fa-qrcode text-xl"></i>
                            </div>
                        </div>
                    </a>

                    <div className="app-card p-6 border-pink-100">
                         <div className="flex justify-between items-center mb-4">
                             <h3 className="text-lg font-black text-slate-700 flex items-center gap-2">
                                <i className="fa-solid fa-coins text-yellow-400"></i> 預算錢包
                             </h3>
                             <button onClick={resetBudget} className="text-xs text-slate-400 hover:text-pink-500 font-bold bg-slate-100 px-2 py-1 rounded-lg">重置手動</button>
                         </div>
                        
                        <div className="mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div className="flex justify-between text-sm mb-2">
                                <span className="text-slate-500 font-bold">已支出 (行程+手動)</span>
                                <span className="font-black text-slate-700 text-lg">¥{totalSpent.toLocaleString()}</span>
                            </div>
                            <div className="w-full bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                                <div className="bg-gradient-to-r from-yellow-300 to-orange-400 h-4 rounded-full transition-all duration-500 shadow-[0_2px_5px_rgba(251,146,60,0.5)]" style={{width: `${percent}%`}}></div>
                            </div>
                            <div className="text-right mt-1">
                                <span className="text-xs text-slate-400 font-bold">剩餘 ¥{remaining.toLocaleString()}</span>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3">
                            <button onClick={() => updateManualSpent(1000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+¥1,000</button>
                            <button onClick={() => updateManualSpent(5000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+¥5,000</button>
                            <button onClick={() => updateManualSpent(10000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+¥10,000</button>
                        </div>
                        <div className="mt-3 text-[10px] text-center text-slate-400">*編輯行程中的費用會自動加總喔！</div>
                    </div>

                    <div className="app-card p-6 border-blue-100">
                        <h3 className="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                            <i className="fa-solid fa-phone-volume text-blue-400"></i> 緊急聯絡
                        </h3>
                        <div className="space-y-3">
                            <div className="flex justify-between items-center py-2 border-b border-dashed border-slate-200">
                                <span className="text-slate-500 text-sm font-bold">報警 / 救護車</span>
                                <span className="font-mono font-black text-slate-700 text-lg">110 / 119</span>
                            </div>
                            <div className="flex justify-between items-center py-2 border-b border-dashed border-slate-200">
                                <span className="text-slate-500 text-sm font-bold">駐日代表處</span>
                                <span className="font-mono font-bold text-slate-700 select-all">+81-3-3280-7811</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [days, setDays] = useState(null); 
            const [budget, setBudget] = useState({ total: 200000, manualSpent: 0 });
            const [expandedDay, setExpandedDay] = useState('day1');
            const [isLoading, setIsLoading] = useState(true);
            const [isLocalMode, setIsLocalMode] = useState(false);

            // 初始化與認證邏輯
            useEffect(() => {
                const initAuth = async () => {
                    // 1. 檢查是否為本地開發/未填寫 Key 的狀態
                    if (firebaseConfig.apiKey === "你的_API_KEY") {
                        console.warn("偵測到未設定 Firebase Key，切換為本地模式 (Local Storage)。");
                        setIsLocalMode(true);
                        
                        // 本地模式：直接讀取 LocalStorage
                        const savedData = localStorage.getItem('trip_data_local');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            setDays(data.days);
                            setBudget(data.budget);
                        } else {
                            setDays(defaultItinerary);
                        }
                        setIsLoading(false);
                        return;
                    }

                    // 2. 嘗試 Firebase 登入
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth 錯誤:", error);
                        // 登入失敗也切回本地模式，避免畫面卡住
                        setIsLocalMode(true);
                        setDays(defaultItinerary);
                        setIsLoading(false);
                    }
                };

                initAuth();

                // 3. 監聽登入狀態 (僅在非本地模式下)
                const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                    if (user && firebaseConfig.apiKey !== "你的_API_KEY") {
                        // 使用正確的 Public Data 路徑: artifacts/appId/public/data/trips/shared_japan_2025
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        
                        try {
                            const docSnap = await getDoc(docRef);
                            if (!docSnap.exists()) {
                                await setDoc(docRef, {
                                    days: defaultItinerary,
                                    budget: { total: 200000, manualSpent: 0 }
                                });
                            }

                            const unsubscribeSnapshot = onSnapshot(docRef, (doc) => {
                                if (doc.exists()) {
                                    const data = doc.data();
                                    setDays(data.days);
                                    if (data.budget) setBudget(data.budget);
                                }
                                setIsLoading(false);
                            });
                            return () => unsubscribeSnapshot();
                        } catch (e) {
                            console.error("Firestore 讀取錯誤:", e);
                            setIsLocalMode(true);
                            setDays(defaultItinerary);
                            setIsLoading(false);
                        }
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            // 更新事件
            const handleUpdateEvent = async (dayId, eventId, newData) => {
                if (!days) return;
                
                const updatedDays = days.map(day => {
                    if (day.id !== dayId) return day;
                    return {
                        ...day,
                        events: day.events.map(ev => {
                            if (ev.id !== eventId) return ev;
                            return { ...ev, ...newData };
                        })
                    };
                });
                
                setDays(updatedDays);

                if (isLocalMode) {
                    localStorage.setItem('trip_data_local', JSON.stringify({ days: updatedDays, budget }));
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await updateDoc(docRef, { days: updatedDays });
                    } catch (e) {
                        console.error("更新失敗:", e);
                    }
                }
            };

            // 更新預算
            const handleUpdateBudget = async (newBudget) => {
                setBudget(newBudget);
                
                if (isLocalMode) {
                    localStorage.setItem('trip_data_local', JSON.stringify({ days, budget: newBudget }));
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await updateDoc(docRef, { budget: newBudget });
                    } catch (e) {
                        console.error("預算更新失敗:", e);
                    }
                }
            };

            useEffect(() => {
                window.scrollTo(0, 0);
            }, [activeTab]);

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-[#fff1f2] flex flex-col items-center justify-center text-pink-400 gap-4">
                        <i className="fa-solid fa-cloud text-6xl chiikawa-bounce"></i>
                        <p className="font-bold text-lg">載入中...</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#fff1f2] overflow-x-hidden">
                    <header className="sticky top-0 z-40 bg-[#fff1f2]/90 backdrop-blur-md px-5 py-4 border-b-2 border-pink-100 flex justify-between items-center shadow-sm">
                        <h1 className="text-2xl font-black text-slate-700 tracking-tight flex items-center gap-2">
                            <span className="text-pink-500 text-3xl">✈️</span>
                            <span>Japan<span className="text-pink-400">Trip</span></span>
                        </h1>
                        <div className="w-10 h-10 rounded-full bg-white border-2 border-pink-200 flex items-center justify-center shadow-sm">
                            <i className="fa-solid fa-face-smile text-pink-400 text-xl"></i>
                        </div>
                    </header>

                    {isLocalMode && (
                        <div className="bg-orange-100 text-orange-700 text-xs font-bold text-center py-2 px-4">
                            <i className="fa-solid fa-triangle-exclamation mr-1"></i>
                            目前為預覽/離線模式 (資料僅存於此裝置)
                        </div>
                    )}

                    <main className="pt-6">
                        {activeTab === 'itinerary' ? (
                            <div className="px-4">
                                {days && days.map(day => (
                                    <DayCard 
                                        key={day.id} 
                                        day={day} 
                                        isExpanded={expandedDay === day.id}
                                        onToggle={() => setExpandedDay(expandedDay === day.id ? null : day.id)}
                                        onUpdateEvent={handleUpdateEvent}
                                    />
                                ))}
                                <div className="text-center text-pink-300 font-bold text-sm mt-8 mb-4">
                                    ~ 旅途愉快 ~
                                </div>
                            </div>
                        ) : (
                            <ToolsView daysData={days || []} budgetData={budget} onUpdateBudget={handleUpdateBudget} />
                        )}
                    </main>

                    <nav className="fixed bottom-6 left-6 right-6 bg-white/95 backdrop-blur rounded-[2rem] shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white z-50 max-w-[calc(28rem-3rem)] mx-auto">
                        <div className="flex justify-around items-center h-16">
                            <button 
                                onClick={() => setActiveTab('itinerary')}
                                className={`flex items-center gap-2 px-6 py-2 rounded-full transition-all duration-300 ${activeTab === 'itinerary' ? 'bg-pink-100 text-pink-500 font-bold' : 'text-slate-400 font-medium'}`}
                            >
                                <i className="fa-solid fa-map-location-dot text-lg"></i>
                                {activeTab === 'itinerary' && <span>行程</span>}
                            </button>
                            <div className="w-px h-8 bg-slate-100"></div>
                            <button 
                                onClick={() => setActiveTab('tools')}
                                className={`flex items-center gap-2 px-6 py-2 rounded-full transition-all duration-300 ${activeTab === 'tools' ? 'bg-pink-100 text-pink-500 font-bold' : 'text-slate-400 font-medium'}`}
                            >
                                <i className="fa-solid fa-suitcase text-lg"></i>
                                {activeTab === 'tools' && <span>工具</span>}
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
