<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 強力防止快取的 Meta 標籤 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Chiikawa Trip v2.7</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fff1f2">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1908/1908344.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Kosugi Maru', -apple-system, sans-serif;
            background-color: #fff1f2;
            background-image: radial-gradient(#fecdd3 1px, transparent 1px);
            background-size: 20px 20px;
            color: #475569;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(251, 113, 133, 0.15);
            border: 2px solid #fff;
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
        }
        .app-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: linear-gradient(to right, #f9a8d4, #f472b6);
        }

        .tag-base { @apply px-2.5 py-1 rounded-full text-xs font-bold mr-1.5 mb-1 inline-block border-2 shadow-sm; }
        .tag-food { @apply bg-orange-100 text-orange-600 border-orange-200; }
        .tag-buy { @apply bg-rose-100 text-rose-600 border-rose-200; }
        .tag-transport { @apply bg-blue-100 text-blue-600 border-blue-200; }
        .tag-highlight { @apply bg-yellow-100 text-yellow-700 border-yellow-200; }
        .tag-code { @apply bg-purple-100 text-purple-600 border-purple-200 font-mono tracking-wider; }
        .tag-cost { @apply bg-emerald-100 text-emerald-600 border-emerald-200; }

        .btn-cute {
            @apply active:scale-95 transition-transform rounded-2xl font-bold shadow-md border-b-4 active:border-b-0 active:translate-y-1;
        }

        /* Loading 動畫 */
        .chiikawa-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, collection } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // =========================================
        // PWA Cache Cleanup
        // =========================================
        if ('serviceWorker' in navigator) {
            try {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister().catch(err => console.warn(err));
                    }
                }).catch(err => console.warn(err));
            } catch (e) { console.warn(e); }

            if ('caches' in window) {
                try {
                    caches.keys().then(function(names) {
                        for (let name of names) caches.delete(name);
                    }).catch(err => console.warn(err));
                } catch (e) { console.warn(e); }
            }
        }

        const { useState, useEffect, useRef } = React;

        // =========================================
        // 1. Firebase Config
        // =========================================
        const getFirebaseConfig = () => {
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    return JSON.parse(__firebase_config);
                }
            } catch (e) {
                console.log("Not in preview mode or config invalid");
            }
            
            return {
                apiKey: "AIzaSyCpOfvR92qEkDHDZio8jZ4VR-tru2MScSQ",
                authDomain: "japan-trip-2025-5f3a3.firebaseapp.com",
                projectId: "japan-trip-2025-5f3a3",
                storageBucket: "japan-trip-2025-5f3a3.firebasestorage.app",
                messagingSenderId: "828851638958",
                appId: "1:828851638958:web:59bad47902fe08671b933f"
            };
        };

        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const TRIP_DOC_PATH = ['artifacts', appId, 'public', 'data', 'trips', 'shared_japan_2025'];
        const LOCAL_STORAGE_KEY = 'trip_data_v2_7'; 

        // =========================================
        // 新版資料結構 (v2.7 詳細版)
        // =========================================
        const defaultItinerary = [
            {
                id: 'day1', date: '5/10 (日)', title: '桃園 → 小松 → 金澤',
                location: '金澤',
                weather: { icon: 'fa-plane', text: '涼爽舒適', temp: '14°C ~ 22°C', alert: false },
                events: [
                    { id: 'e1-1', type: 'transport', time: '12:10', title: 'IT 252 起飛', desc: '桃園 T1 → 小松機場 (16:05 抵達)。機上可先填寫入境卡。', location: '桃園國際機場' },
                    { id: 'e1-2', type: 'transport', time: '17:00', title: '機場巴士 → 金澤', desc: '出關後左轉至巴士站。車程約40分，沿途欣賞田園風光。', location: '小松機場', cost: 1150 },
                    { id: 'e1-3', type: 'food', time: '18:30', title: '晚餐: 金澤百番街', desc: '推薦:【8番拉麵 (8番らーめん)】北陸靈魂美食！\n★必點: 野菜拉麵(鹽味)、煎餃。湯頭清甜，蔬菜量大。', location: '金澤車站' },
                    { id: 'e1-4', type: 'accommodation', time: '20:00', title: '住宿: 金澤大酒店', desc: '離車站走路 3 分鐘。大廳有免費咖啡。', location: 'Kanazawa Hotel', bookingCode: '5949989585-PIN:3738', cost: 60554, note: '5/8前可取消' },
                ]
            },
            {
                id: 'day2', date: '5/11 (一)', title: '金澤古都一日遊',
                location: '金澤',
                weather: { icon: 'fa-sun', text: '晴時多雲', temp: '15°C ~ 24°C', alert: false },
                events: [
                    { id: 'e2-1', type: 'transport', time: '09:00', title: 'Loop Bus 一日券', desc: 'JR 金澤站東口購買。可無限次搭乘城下町周遊巴士。', location: '金澤車站', cost: 600 },
                    { id: 'e2-2', type: 'sight', time: '09:30', title: '兼六園 & 金澤城', desc: '日本三大名園之一。\n★必拍: 徽軫燈籠 (琴柱燈籠)、唐崎松。\n建議從桂坂口進入，早上光線最美，遊客較少。', location: '兼六園' },
                    { id: 'e2-3', type: 'food', time: '12:00', title: '午餐: 近江町市場', desc: '金澤人的廚房！\n推薦:【山さん壽司】或【もりもり寿し(迴轉壽司)】\n★必點: 豪華海鮮丼(上有金箔)、喉黑魚(のどぐろ)握壽司。', location: '近江町市場' },
                    { id: 'e2-4', type: 'sight', time: '14:00', title: '東茶屋街', desc: '江戶時代的茶屋建築群。\n★必吃: 箔一金箔冰淇淋 (整片金箔貼上去！)。\n★必逛: 久連波 (和菓子)、懷華樓 (參觀茶屋內部)。', location: '東茶屋街' },
                    { id: 'e2-5', type: 'sight', time: '16:00', title: '長町武家屋敷', desc: '昔日武士居住的街道，土牆與石板路非常有氣氛。\n推薦參觀「野村家」，庭園設計非常精緻。', location: '長町武家屋敷跡' },
                    { id: 'e2-6', type: 'food', time: '18:00', title: '晚餐: 金澤咖哩', desc: '推薦:【Go Go Curry (ゴーゴーカレー)】\n★必點: 炸豬排咖哩 (Loin Katsu Curry)。\n特色: 黑咖哩醬汁濃郁，用不鏽鋼盤裝盛，配上高麗菜絲。', location: 'Go Go Curry Kanazawa Station' },
                    { id: 'e2-7', type: 'accommodation', time: '20:00', title: '住宿: 金澤續住', desc: '同第一晚。記得先整理部分行李準備寄送。', location: 'Kanazawa Hotel' },
                ]
            },
            {
                id: 'day3', date: '5/12 (二)', title: '合掌村 → 飛驒高山',
                location: '高山',
                weather: { icon: 'fa-cloud', text: '山區偏涼', temp: '12°C ~ 20°C', alert: false },
                events: [
                    { id: 'e3-1', type: 'transport', time: '09:00', title: '租車出發', desc: '自駕前往白川鄉 (約1小時15分)。山路好開但注意限速。', location: '金澤車站租車' },
                    { id: 'e3-2', type: 'sight', time: '10:30', title: '白川鄉合掌村', desc: '世界遺產童話村落。\n★必拍: 城山天守閣展望台 (可搭接駁車上去)，俯瞰全村美景。\n參觀: 和田家 (最大合掌造建築)。', location: '白川鄉' },
                    { id: 'e3-3', type: 'food', time: '12:30', title: '午餐: 合掌村小吃', desc: '推薦:【基太の庄】或【伊呂波】\n★必點: 朴葉味噌燒定食、五平餅 (核桃味噌醬烤米餅)、飛驒牛可樂餅。', location: '白川鄉' },
                    { id: 'e3-4', type: 'transport', time: '14:30', title: '前往高山', desc: '開車約 50 分鐘。前往飛驒高山古街。', location: '高山三町筋' },
                    { id: 'e3-5', type: 'sight', time: '15:30', title: '高山古街 (三町通)', desc: '保留江戶時代風貌的老街。\n★必吃: 飛驒牛握壽司 (坂口屋/こって牛)、飛驒牛串燒。\n★必買: 猿寶寶 (Sarubobo) 玩偶。', location: '高山老街' },
                    { id: 'e3-6', type: 'food', time: '18:00', title: '晚餐: 飛驒牛燒肉', desc: '推薦:【味藏天國】或【丸明】\n★必點: 飛驒牛拼盤 (A5等級)、牛舌。\n肉質入口即化，建議先訂位！', location: '味藏天國' },
                    { id: 'e3-7', type: 'accommodation', time: '20:00', title: '住宿: Residence 高山', desc: '離車站近，有小廚房。訂單: 6171736740-PIN:1772', location: 'Residence Hotel Takayama Station', bookingCode: '6171736740', cost: 55869 },
                ]
            },
            {
                id: 'day4', date: '5/13 (三)', title: '高山朝市 → 富山',
                location: '富山',
                weather: { icon: 'fa-cloud-sun', text: '舒適宜人', temp: '14°C ~ 23°C', alert: false },
                events: [
                    { id: 'e4-1', type: 'sight', time: '08:00', title: '宮川朝市', desc: '日本三大朝市之一，沿著河邊擺攤。\n★必買: 蘋果、手工味噌、朝市布丁。\n早晨空氣很好，適合散步拍照。', location: '宮川朝市' },
                    { id: 'e4-2', type: 'transport', time: '14:00', title: '前往富山', desc: 'JR高山本線 (特急 Hida)，約1.5小時。沿途峽谷風景秀麗。', location: '富山車站', cost: 2860 },
                    { id: 'e4-3', type: 'accommodation', time: '16:00', title: '住宿: 東橫INN 富山站', desc: '新幹線口2號店。就在車站旁，方便明天寄行李。', location: 'Toyoko Inn Toyama-eki Shinkansen-guchi No.2', bookingCode: '5361206-7', cost: 40870 },
                    { id: 'e4-4', type: 'food', time: '18:00', title: '晚餐: 富山灣寶石', desc: '推薦:【白蝦亭 (白えび亭)】位於富山站內。\n★必點: 白蝦刺身丼 (鮮甜！)、白蝦天婦羅。\n或者嘗試【富山黑拉麵 (西町大喜)】，口味偏鹹請注意。', location: '白蝦亭' },
                    { id: 'e4-5', type: 'sight', time: '20:00', title: '富岩運河環水公園', desc: '擁有「世界最美星巴克」。晚上點燈非常浪漫，適合散步消化。', location: '富岩運河環水公園' },
                ]
            },
            {
                id: 'day5', date: '5/14 (四)', title: '穿越立山黑部',
                location: '長野',
                weather: { icon: 'fa-snowflake', text: '高山寒冷', temp: '2°C ~ 10°C', alert: true },
                events: [
                    { id: 'e5-1', type: 'transport', time: '07:00', title: '★ 寄行李', desc: '將大行李寄往長野/東京(當天可能無法到，建議寄到東京)。隨身帶保暖衣物。', location: '富山車站' },
                    { id: 'e5-2', type: 'transport', time: '08:00', title: '電鐵 富山→立山站', desc: '約1小時。抵達後換乘登山纜車。', location: '立山站', cost: 1230 },
                    { id: 'e5-3', type: 'sight', time: '10:00', title: '室堂 (雪之大谷)', desc: '海拔2450m。五月仍有壯觀雪壁。\n★必做: 漫步在雪之大谷、去御庫裏池拍倒影。\n午餐推薦: 立山蕎麥麵 (立山站) 或 室堂名物「星之雫」起司蛋糕。', location: '室堂' },
                    { id: 'e5-4', type: 'sight', time: '13:00', title: '大觀峰 & 黑部水庫', desc: '搭乘空中纜車無支柱設計，景色絕美。\n黑部水庫: 日本最高拱形水庫，爬上展望台視野最好。', location: '黑部水庫' },
                    { id: 'e5-5', type: 'transport', time: '15:00', title: '扇澤 → 長野站', desc: 'ALPICO巴士，約1小時40分。下山後一路睡到長野。', location: '扇澤站', cost: 2000 },
                    { id: 'e5-6', type: 'food', time: '18:30', title: '晚餐: 信州味噌拉麵', desc: '推薦:【味噌家 (Misoya)】長野站附近。\n★必點: 叉燒味噌拉麵。使用信州味噌，湯頭濃郁暖胃。', location: 'Misoya Nagano' },
                    { id: 'e5-7', type: 'accommodation', time: '20:00', title: '住宿: 長野日航酒店', desc: '舒適好睡。訂單: 6128676866-PIN:0175', location: 'Hotel Jal City Nagano', bookingCode: '6128676866', cost: 36402 },
                ]
            },
            {
                id: 'day6', date: '5/15 (五)', title: '長野 → 東京',
                location: '東京',
                weather: { icon: 'fa-city', text: '多雲時晴', temp: '18°C ~ 25°C', alert: false },
                events: [
                    { id: 'e6-1', type: 'sight', time: '09:00', title: '善光寺 (選)', desc: '如果早起可去。日本重要寺廟，「再遠也要去一次善光寺」。', location: '善光寺' },
                    { id: 'e6-2', type: 'transport', time: '10:30', title: '新幹線 → 東京', desc: '北陸新幹線 Kagayaki，約1.5小時直達東京。', location: '東京車站', cost: 8000 },
                    { id: 'e6-3', type: 'sight', time: '13:00', title: '淺草雷門 & 仲見世通', desc: '東京必遊地標。\n★必拍: 雷門大燈籠、晴空塔遠景。\n★小吃: 吉備糰子、人形燒、炸肉餅。', location: '雷門' },
                    { id: 'e6-4', type: 'food', time: '18:00', title: '晚餐: 鰻魚飯 / 壽喜燒', desc: '推薦:【淺草 今半 (壽喜燒)】需預約，午間套餐較划算。\n或【色川鰻魚飯】炭火現烤。\n預算有限推薦:【宇奈とと】平價鰻魚飯。', location: '淺草 今半' },
                    { id: 'e6-5', type: 'accommodation', time: '20:00', title: '住宿: 上野第一都市酒店', desc: '交通方便，離阿美橫町近。訂單: 5038002965', location: 'Ueno First City Hotel', bookingCode: '5038002965', cost: 63812 },
                ]
            },
            {
                id: 'day7', date: '5/16 (六)', title: '東京自由行',
                location: '東京',
                weather: { icon: 'fa-bag-shopping', text: '逛街日', temp: '19°C ~ 26°C', alert: false },
                events: [
                    { id: 'e7-1', type: 'activity', time: '10:00', title: '方案1: 上野阿美橫町', desc: '藥妝、零食大採購。\n★必買: 二木之菓子 (伴手禮)、OS Drug (藥妝便宜)。', location: '阿美橫町' },
                    { id: 'e7-2', type: 'activity', time: '10:00', title: '方案2: 晴空塔 Solamachi', desc: '購物中心超好逛。\n★必逛: 寶可夢中心、吉卜力共和國、Loft。\n午餐推薦:【六厘舍】沾麵 (排隊名店)。', location: '東京晴空塔' },
                    { id: 'e7-3', type: 'activity', time: '10:00', title: '方案3: 台場 DiverCity', desc: '看獨角獸鋼彈變身。\n★必拍: 自由女神像、彩虹大橋夜景。', location: '台場' },
                    { id: 'e7-4', type: 'food', time: '18:00', title: '晚餐: 居酒屋體驗', desc: '推薦:【鳥貴族】全品項均一價，平價連鎖串燒。\n★必點: 貴族燒 (雞腿肉蔥串)、釜飯、起司肉丸。', location: '鳥貴族 上野' },
                    { id: 'e7-5', type: 'accommodation', time: '21:00', title: '住宿: 成田東武機場酒店', desc: '移動至機場附近，方便明早班機。訂單: 5068249636', location: 'Narita Tobu Hotel Airport', bookingCode: '5068249636', cost: 36086 },
                ]
            },
            {
                id: 'day8', date: '5/17 (日)', title: '成田 → 高雄',
                location: '成田',
                weather: { icon: 'fa-plane-departure', text: '多雲', temp: '20°C', alert: false },
                events: [
                    { id: 'e8-1', type: 'transport', time: '09:00', title: '前往機場', desc: '搭乘飯店免費接駁巴士前往成田 T2。', location: '成田機場' },
                    { id: 'e8-2', type: 'activity', time: '10:00', title: '機場最後採買', desc: '免稅店掃貨。\n★必買: ROYCE 生巧克力、東京香蕉、LeTAO 起司蛋糕、獺祭二割三。', location: '成田機場免稅店' },
                    { id: 'e8-3', type: 'food', time: '11:30', title: '午餐: 機場美食', desc: '推薦: T2 4樓美食街。\n想吃好一點可選【壽司田】或簡單吃【麥當勞】(有日本限定口味)。', location: '成田機場第二航廈' },
                    { id: 'e8-4', type: 'transport', time: '13:30', title: 'IT 281 起飛', desc: '成田 → 高雄 (16:40 抵達)。回家囉！', location: '成田機場第二航廈' },
                ]
            }
        ];

        // =========================================
        // Components
        // =========================================

        const NavigateButton = ({ location }) => {
            if (!location) return null;
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
            return (
                <a href={mapsUrl} target="_blank" rel="noopener noreferrer" 
                   className="inline-flex items-center gap-1.5 bg-sky-200 text-sky-700 text-xs px-3 py-1.5 rounded-2xl font-bold shadow-sm hover:bg-sky-300 active:scale-95 transition-all mt-2 no-underline border border-sky-300">
                    <i className="fa-solid fa-location-arrow text-[0.7rem]"></i>
                    <span>Go!</span>
                </a>
            );
        };

        const Tag = ({ type, text }) => {
            let colorClass = "tag-base bg-slate-100 text-slate-600 border-slate-200";
            if (type === 'must-eat') colorClass = "tag-base tag-food";
            if (type === 'must-buy') colorClass = "tag-base tag-buy";
            if (type === 'transport') colorClass = "tag-base tag-transport";
            if (type === 'highlight') colorClass = "tag-base tag-highlight";
            if (type === 'code') colorClass = "tag-base tag-code";
            if (type === 'cost') colorClass = "tag-base tag-cost";
            return <span className={colorClass}>{text}</span>;
        };

        const EditModal = ({ event, onClose, onSave }) => {
            const [title, setTitle] = useState(event.title || '');
            const [time, setTime] = useState(event.time || '');
            const [location, setLocation] = useState(event.location || '');
            const [bookingCode, setBookingCode] = useState(event.bookingCode || '');
            const [cost, setCost] = useState(event.cost || '');
            const [note, setNote] = useState(event.note || '');
            const [desc, setDesc] = useState(event.desc || '');

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl border-4 border-pink-200 animate-[bounce_0.2s_ease-out] max-h-[90vh] overflow-y-auto">
                        <h3 className="text-xl font-bold text-pink-500 mb-4 flex items-center gap-2">
                            <i className="fa-solid fa-pen-to-square"></i> 編輯行程
                        </h3>
                        <div className="space-y-3">
                             <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">時間</label>
                                <input type="text" value={time} onChange={(e) => setTime(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">標題</label>
                                <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400 font-bold text-slate-700" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">詳細說明 (介紹/菜單)</label>
                                <textarea value={desc} onChange={(e) => setDesc(e.target.value)} rows="3" className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400 text-sm"></textarea>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">地點</label>
                                <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">代碼</label>
                                    <input type="text" value={bookingCode} onChange={(e) => setBookingCode(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">費用</label>
                                    <input type="number" value={cost} onChange={(e) => setCost(e.target.value)} className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 ml-1">備註</label>
                                <textarea value={note} onChange={(e) => setNote(e.target.value)} rows="2" className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-3 py-2 focus:border-pink-400 resize-none"></textarea>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-2.5 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors">取消</button>
                            <button onClick={() => onSave({ title, time, location, bookingCode, cost, note, desc })} className="flex-1 py-2.5 rounded-xl font-bold text-white bg-pink-400 hover:bg-pink-500 shadow-md shadow-pink-200 transition-colors">儲存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TimelineItem = ({ event, isLast, onEdit }) => {
            let icon = 'fa-circle';
            let iconColor = 'text-slate-400';
            let iconBg = 'bg-slate-100';

            switch(event.type) {
                case 'transport': icon = 'fa-train-subway'; iconColor = 'text-blue-500'; iconBg = 'bg-blue-100'; break;
                case 'food': icon = 'fa-utensils'; iconColor = 'text-orange-500'; iconBg = 'bg-orange-100'; break;
                case 'sight': icon = 'fa-camera'; iconColor = 'text-teal-600'; iconBg = 'bg-teal-100'; break;
                case 'accommodation': icon = 'fa-bed'; iconColor = 'text-purple-500'; iconBg = 'bg-purple-100'; break;
                case 'activity': icon = 'fa-star'; iconColor = 'text-yellow-500'; iconBg = 'bg-yellow-100'; break;
            }

            return (
                <div className="relative pl-4 pb-8 last:pb-2 group">
                    {!isLast && <div className="absolute left-[27px] top-8 bottom-0 w-0.5 bg-slate-200 border-l-2 border-dotted border-slate-300 h-full"></div>}
                    <div className="flex gap-4">
                        <div className={`relative z-10 w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 border-2 border-white shadow-md ${iconBg} ${iconColor}`}>
                            <i className={`fa-solid ${icon} text-sm`}></i>
                        </div>
                        <div className="flex-1 pt-0.5 min-w-0">
                            <div className="flex items-baseline justify-between mb-1">
                                <span className="font-bold text-slate-700 text-lg leading-tight mr-2">{event.title}</span>
                                <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg whitespace-nowrap">{event.time}</span>
                            </div>
                            <div className="mb-2 flex flex-wrap gap-1">
                                {event.bookingCode && <Tag type="code" text={`代碼: ${event.bookingCode}`} />}
                                {event.cost && <Tag type="cost" text={`¥${event.cost}`} />}
                            </div>
                            
                            {/* 描述區域優化：支援換行顯示 */}
                            <p className="text-sm text-slate-500 leading-relaxed mb-2 whitespace-pre-line bg-white/50 p-2 rounded-lg border border-slate-100">
                                {event.desc}
                            </p>
                            
                            {event.note && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-xs text-yellow-800 mb-2">
                                    <i className="fa-regular fa-note-sticky mr-1"></i> {event.note}
                                </div>
                            )}
                            <div className="flex items-center gap-2">
                                <NavigateButton location={event.location} />
                                <button onClick={() => onEdit(event)} className="mt-2 text-xs text-pink-400 font-bold px-3 py-1.5 rounded-2xl border border-pink-200 hover:bg-pink-50 transition-colors flex items-center gap-1">
                                    <i className="fa-solid fa-pen"></i> 編輯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DayCard = ({ day, isExpanded, onToggle, onUpdateEvent }) => {
            const [editingEvent, setEditingEvent] = useState(null);
            const handleSave = (data) => {
                onUpdateEvent(day.id, editingEvent.id, data);
                setEditingEvent(null);
            };

            return (
                <div className="app-card mb-5">
                    <div onClick={onToggle} className="p-4 flex items-center justify-between cursor-pointer active:bg-pink-50/50">
                        <div>
                            <div className="text-xs font-bold text-pink-500 uppercase tracking-wider mb-0.5 flex items-center gap-1">
                                <i className="fa-regular fa-calendar-check"></i> {day.date}
                            </div>
                            <h2 className="text-xl font-black text-slate-700">{day.title}</h2>
                        </div>
                        <div className={`w-8 h-8 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                            <i className="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                    {isExpanded && (
                        <div>
                            {/* 天氣與氣溫 Bar */}
                            <div className={`mx-4 px-4 py-3 rounded-xl flex items-center justify-between text-sm font-bold border-2 ${day.weather.alert ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-sky-50 text-sky-600 border-sky-100'}`}>
                                <div className="flex items-center gap-2">
                                    <i className={`fa-solid ${day.weather.icon} text-lg`}></i>
                                    <span>{day.weather.text}</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    {day.weather.temp && <span className="bg-white/60 px-2 py-0.5 rounded text-xs"><i className="fa-solid fa-temperature-half mr-1"></i>{day.weather.temp}</span>}
                                    {day.weather.alert && <span className="text-[10px] bg-amber-200 text-amber-800 px-2 py-1 rounded-full animate-bounce">注意</span>}
                                </div>
                            </div>
                            <div className="p-4">
                                {day.events.map((event, index) => (
                                    <TimelineItem key={event.id} event={event} isLast={index === day.events.length - 1} onEdit={setEditingEvent} />
                                ))}
                            </div>
                        </div>
                    )}
                    {editingEvent && <EditModal event={editingEvent} onClose={() => setEditingEvent(null)} onSave={handleSave} />}
                </div>
            );
        };

        const ToolsView = ({ daysData, budgetData, onUpdateBudget, onResetData }) => {
            const itineraryCost = daysData.reduce((total, day) => {
                return total + day.events.reduce((dayTotal, event) => {
                    return dayTotal + (parseInt(event.cost) || 0);
                }, 0);
            }, 0);

            const totalSpent = (budgetData?.manualSpent || 0) + itineraryCost;
            const remaining = (budgetData?.total || 0) - totalSpent;
            const percent = Math.min(100, (totalSpent / (budgetData?.total || 1)) * 100);

            const updateManualSpent = (amount) => {
                if (onUpdateBudget) {
                    onUpdateBudget({ ...budgetData, manualSpent: (budgetData?.manualSpent || 0) + amount });
                }
            };

            const resetBudget = () => {
                if (onUpdateBudget) {
                    onUpdateBudget({ ...budgetData, manualSpent: 0 });
                }
            };

            return (
                <div className="space-y-6 pb-24 p-4">
                    <a href="https://www.vjw.digital.go.jp/" target="_blank" rel="noopener noreferrer" 
                       className="block bg-gradient-to-r from-pink-400 to-rose-400 rounded-3xl p-1 shadow-lg transform active:scale-95 transition-transform">
                        <div className="bg-white/10 rounded-[1.3rem] p-4 flex items-center justify-between text-white">
                            <div>
                                <div className="text-xs font-bold opacity-90 mb-1">入境必備</div>
                                <div className="text-xl font-black">Visit Japan Web</div>
                            </div>
                            <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i className="fa-solid fa-qrcode text-xl"></i>
                            </div>
                        </div>
                    </a>

                    <div className="app-card p-6 border-pink-100">
                         <div className="flex justify-between items-center mb-4">
                             <h3 className="text-lg font-black text-slate-700 flex items-center gap-2">
                                <i className="fa-solid fa-coins text-yellow-400"></i> 預算錢包
                             </h3>
                             <button onClick={resetBudget} className="text-xs text-slate-400 hover:text-pink-500 font-bold bg-slate-100 px-2 py-1 rounded-lg">重置手動</button>
                          </div>
                         
                        <div className="mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div className="flex justify-between text-sm mb-2">
                                <span className="text-slate-500 font-bold">已支出 (行程+手動)</span>
                                <span className="font-black text-slate-700 text-lg">¥{totalSpent.toLocaleString()}</span>
                            </div>
                            <div className="w-full bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                                <div className="bg-gradient-to-r from-yellow-300 to-orange-400 h-4 rounded-full transition-all duration-500 shadow-[0_2px_5px_rgba(251,146,60,0.5)]" style={{width: `${percent}%`}}></div>
                            </div>
                            <div className="text-right mt-1">
                                <span className="text-xs text-slate-400 font-bold">剩餘 ¥{remaining.toLocaleString()}</span>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3">
                            <button onClick={() => updateManualSpent(1000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+¥1,000</button>
                            <button onClick={() => updateManualSpent(5000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+¥5,000</button>
                            <button onClick={() => updateManualSpent(10000)} className="btn-cute py-3 bg-white text-slate-600 border-2 border-slate-100 hover:border-pink-200 hover:text-pink-500">+¥10,000</button>
                        </div>
                    </div>

                    <div className="app-card p-6 border-blue-100">
                        <h3 className="text-lg font-black text-slate-700 mb-4 flex items-center gap-2">
                            <i className="fa-solid fa-phone-volume text-blue-400"></i> 緊急聯絡
                        </h3>
                        <div className="space-y-3">
                            <div className="flex justify-between items-center py-2 border-b border-dashed border-slate-200">
                                <span className="text-slate-500 text-sm font-bold">報警 / 救護車</span>
                                <span className="font-mono font-black text-slate-700 text-lg">110 / 119</span>
                            </div>
                            <div className="flex justify-between items-center py-2 border-b border-dashed border-slate-200">
                                <span className="text-slate-500 text-sm font-bold">駐日代表處</span>
                                <span className="font-mono font-bold text-slate-700 select-all">+81-3-3280-7811</span>
                            </div>
                        </div>
                    </div>

                    <div className="mt-8 border-t border-slate-200 pt-6">
                        <button onClick={onResetData} className="w-full py-3 bg-rose-50 text-rose-500 font-bold rounded-2xl border-2 border-rose-100 hover:bg-rose-100 active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i className="fa-solid fa-rotate-right"></i>
                            ⚠️ 強制重置為「v2.7 詳細版」行程
                        </button>
                        <p className="text-center text-[10px] text-slate-400 mt-2">更新程式碼後，請務必按此按鈕載入新資料</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            const [days, setDays] = useState(null); 
            const [budget, setBudget] = useState({ total: 200000, manualSpent: 0 });
            const [expandedDay, setExpandedDay] = useState('day1');
            const [isLoading, setIsLoading] = useState(true);
            const [isLocalMode, setIsLocalMode] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    if (firebaseConfig.apiKey === "你的_API_KEY") {
                        console.warn("Local Mode Active");
                        setIsLocalMode(true);
                        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            setDays(data.days);
                            setBudget(data.budget);
                        } else {
                            setDays(defaultItinerary);
                        }
                        setIsLoading(false);
                        return;
                    }

                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                        setIsLocalMode(true);
                        setDays(defaultItinerary);
                        setIsLoading(false);
                    }
                };

                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                    if (user && firebaseConfig.apiKey !== "你的_API_KEY") {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        
                        try {
                            const docSnap = await getDoc(docRef);
                            if (!docSnap.exists()) {
                                await setDoc(docRef, {
                                    days: defaultItinerary,
                                    budget: { total: 200000, manualSpent: 0 }
                                });
                            }

                            const unsubscribeSnapshot = onSnapshot(docRef, (doc) => {
                                if (doc.exists()) {
                                    const data = doc.data();
                                    setDays(data.days);
                                    if (data.budget) setBudget(data.budget);
                                }
                                setIsLoading(false);
                            });
                            return () => unsubscribeSnapshot();
                        } catch (e) {
                            console.error("Firestore Error:", e);
                            setIsLocalMode(true);
                            setDays(defaultItinerary);
                            setIsLoading(false);
                        }
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            const handleResetData = async () => {
                if (!confirm("確定要重置嗎？這會清除目前的修改，並載入包含「天氣、詳細景點、美食推薦」的 v2.7 版行程。")) return;
                
                const newBudget = { total: 200000, manualSpent: 0 };
                setDays(defaultItinerary);
                setBudget(newBudget);

                if (isLocalMode) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ days: defaultItinerary, budget: newBudget }));
                    alert("本地資料已更新 v2.7！");
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await setDoc(docRef, { 
                            days: defaultItinerary, 
                            budget: newBudget 
                        });
                        alert("雲端資料已成功升級為 v2.7！");
                    } catch (e) {
                        console.error("Reset Error:", e);
                        alert("重置失敗，請檢查網路。");
                    }
                }
            };

            const handleUpdateEvent = async (dayId, eventId, newData) => {
                if (!days) return;
                
                const updatedDays = days.map(day => {
                    if (day.id !== dayId) return day;
                    return {
                        ...day,
                        events: day.events.map(ev => {
                            if (ev.id !== eventId) return ev;
                            return { ...ev, ...newData };
                        })
                    };
                });
                
                setDays(updatedDays);

                if (isLocalMode) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ days: updatedDays, budget }));
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await updateDoc(docRef, { days: updatedDays });
                    } catch (e) {
                        console.error("Update Error:", e);
                    }
                }
            };

            const handleUpdateBudget = async (newBudget) => {
                setBudget(newBudget);
                
                if (isLocalMode) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ days, budget: newBudget }));
                } else {
                    try {
                        const docRef = doc(db, ...TRIP_DOC_PATH);
                        await updateDoc(docRef, { budget: newBudget });
                    } catch (e) {
                        console.error("Budget Error:", e);
                    }
                }
            };

            useEffect(() => {
                window.scrollTo(0, 0);
            }, [activeTab]);

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-[#fff1f2] flex flex-col items-center justify-center text-pink-400 gap-4">
                        <i className="fa-solid fa-cloud text-6xl chiikawa-bounce"></i>
                        <p className="font-bold text-lg">載入中...</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#fff1f2] overflow-x-hidden">
                    <div className="bg-emerald-500 text-white text-xs font-bold text-center py-2 px-4 shadow-md sticky top-0 z-50">
                        <i className="fa-solid fa-check-circle mr-1"></i>
                        v2.7 升級成功：請至工具頁「強制重置」以載入新內容
                    </div>

                    <header className="sticky top-8 z-40 bg-[#fff1f2]/90 backdrop-blur-md px-5 py-4 border-b-2 border-pink-100 flex justify-between items-center shadow-sm">
                        <h1 className="text-2xl font-black text-slate-700 tracking-tight flex items-center gap-2">
                            <span className="text-pink-500 text-3xl">✨</span> 
                            <span>Japan<span className="text-pink-400">Trip</span></span>
                        </h1>
                        <div className="w-10 h-10 rounded-full bg-white border-2 border-pink-200 flex items-center justify-center shadow-sm">
                            <i className="fa-solid fa-face-smile text-pink-400 text-xl"></i>
                        </div>
                    </header>

                    {isLocalMode && (
                        <div className="bg-orange-100 text-orange-700 text-xs font-bold text-center py-2 px-4">
                            <i className="fa-solid fa-triangle-exclamation mr-1"></i>
                            目前為預覽/離線模式 (資料僅存於此裝置)
                        </div>
                    )}

                    <main className="pt-6">
                        {activeTab === 'itinerary' ? (
                            <div className="px-4">
                                {days && days.map(day => (
                                    <DayCard 
                                        key={day.id} 
                                        day={day} 
                                        isExpanded={expandedDay === day.id}
                                        onToggle={() => setExpandedDay(expandedDay === day.id ? null : day.id)}
                                        onUpdateEvent={handleUpdateEvent}
                                    />
                                ))}
                                <div className="text-center text-pink-300 font-bold text-sm mt-8 mb-4">
                                    ~ 旅途愉快 v2.7 詳細版 ~
                                </div>
                            </div>
                        ) : (
                            <ToolsView 
                                daysData={days || []} 
                                budgetData={budget} 
                                onUpdateBudget={handleUpdateBudget} 
                                onResetData={handleResetData}
                            />
                        )}
                    </main>

                    <nav className="fixed bottom-6 left-6 right-6 bg-white/95 backdrop-blur rounded-[2rem] shadow-[0_8px_30px_rgba(0,0,0,0.12)] border border-white z-50 max-w-[calc(28rem-3rem)] mx-auto">
                        <div className="flex justify-around items-center h-16">
                            <button 
                                onClick={() => setActiveTab('itinerary')}
                                className={`flex items-center gap-2 px-6 py-2 rounded-full transition-all duration-300 ${activeTab === 'itinerary' ? 'bg-pink-100 text-pink-500 font-bold' : 'text-slate-400 font-medium'}`}
                            >
                                <i className="fa-solid fa-map-location-dot text-lg"></i>
                                {activeTab === 'itinerary' && <span>行程</span>}
                            </button>
                            <div className="w-px h-8 bg-slate-100"></div>
                            <button 
                                onClick={() => setActiveTab('tools')}
                                className={`flex items-center gap-2 px-6 py-2 rounded-full transition-all duration-300 ${activeTab === 'tools' ? 'bg-pink-100 text-pink-500 font-bold' : 'text-slate-400 font-medium'}`}
                            >
                                <i className="fa-solid fa-suitcase text-lg"></i>
                                {activeTab === 'tools' && <span>工具</span>}
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>